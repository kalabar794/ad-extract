<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epstein Archive Investigator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 100%);
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        h1 {
            color: #fff;
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff 0%, #e74c3c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #a0a0a0;
            font-size: 15px;
            font-weight: 400;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(231, 76, 60, 0.2);
            border-color: rgba(231, 76, 60, 0.3);
        }

        .stat-number {
            font-size: 42px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #a0a0a0;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tab {
            padding: 14px 28px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a0a0a0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tab.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 4px 20px rgba(231, 76, 60, 0.4);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 500px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            background: rgba(255, 255, 255, 0.02);
        }

        .upload-zone:hover {
            border-color: rgba(231, 76, 60, 0.6);
            background: rgba(231, 76, 60, 0.05);
            transform: scale(1.01);
        }

        .upload-zone.dragover {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            transform: scale(1.02);
        }

        .search-box {
            width: 100%;
            padding: 18px 24px;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .search-box:focus {
            outline: none;
            border-color: #e74c3c;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.2);
        }

        .document-list {
            display: grid;
            gap: 15px;
        }

        .document-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #555;
            cursor: pointer;
            transition: all 0.3s;
        }

        .document-item:hover {
            border-left-color: #d32f2f;
            background: #252525;
        }

        .document-item.txt {
            border-left-color: #4caf50;
        }

        .document-item.image {
            border-left-color: #2196f3;
        }

        .doc-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #fff;
        }

        .doc-meta {
            font-size: 12px;
            color: #999;
        }

        .snippet {
            margin-top: 10px;
            padding: 10px;
            background: #252525;
            border-radius: 4px;
            font-size: 14px;
        }

        .snippet mark {
            background: #d32f2f;
            color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .entity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .entity-card {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
        }

        .entity-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .entity-type {
            display: inline-block;
            padding: 2px 8px;
            background: #555;
            border-radius: 4px;
            font-size: 11px;
            color: #fff;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .entity-type.person { background: #4caf50; }
        .entity-type.location { background: #2196f3; }
        .entity-type.date { background: #ff9800; }

        #network-container {
            width: 100%;
            height: 600px;
            background: #1a1a1a;
            border: 2px solid #555;
            border-radius: 8px;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ff9800;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -38px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: #ff9800;
            border-radius: 50%;
            border: 3px solid #2d2d2d;
        }

        .timeline-date {
            font-weight: bold;
            color: #ff9800;
            margin-bottom: 5px;
        }

        .btn {
            padding: 10px 20px;
            background: #d32f2f;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #b71c1c;
        }

        .btn-secondary {
            background: #555;
        }

        .btn-secondary:hover {
            background: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .gallery-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .gallery-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            font-size: 12px;
            color: #fff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #d32f2f;
            color: #fff;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .doc-content {
            white-space: pre-wrap;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            line-height: 1.8;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>EPSTEIN ARCHIVE INVESTIGATOR</h1>
            <p class="subtitle">Local Document Analysis Platform</p>
        </div>
    </header>

    <div class="container">
        <!-- NEW FEATURE BANNER -->
        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); padding: 20px 30px; border-radius: 15px; margin-bottom: 30px; border: 2px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px rgba(255, 152, 0, 0.3); cursor: pointer;" onclick="window.location.href='/contradictions'">
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="font-size: 48px;">‚ö†Ô∏è</div>
                <div style="flex: 1;">
                    <div style="font-size: 20px; font-weight: bold; color: white; margin-bottom: 5px;">
                        üéâ NEW: Automated Contradiction Detection Engine
                    </div>
                    <div style="color: rgba(255, 255, 255, 0.9); font-size: 14px;">
                        AI-powered system that automatically finds contradictions in testimonies, depositions, and documents. Click to analyze your data!
                    </div>
                </div>
                <div>
                    <button style="padding: 12px 24px; background: white; color: #ff9800; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">
                        Launch ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="stat-documents">0</div>
                <div class="stat-label">Text Documents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-images">0</div>
                <div class="stat-label">Images</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-entities">0</div>
                <div class="stat-label">Entities Extracted</div>
            </div>
            <div class="stat-card" onclick="window.location.href='/contradictions'" style="cursor: pointer;">
                <div class="stat-number" id="stat-contradictions" style="color: #ff9800;">0</div>
                <div class="stat-label">‚ö†Ô∏è Contradictions Detected</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">Upload</button>
            <button class="tab" onclick="switchTab('search')">Search</button>
            <button class="tab" onclick="switchTab('ai-journalist')" style="background: #f50057; color: white; font-weight: bold; font-size: 16px;">üéØ AI JOURNALIST</button>
            <button class="tab" onclick="switchTab('ai-investigation')" style="background: #d32f2f; color: white;">ü§ñ AI Investigation</button>
            <button class="tab" onclick="window.location.href='/contradictions'" style="background: #ff9800; color: white; font-weight: bold;">‚ö†Ô∏è CONTRADICTIONS</button>
            <button class="tab" onclick="switchTab('leads')" style="background: #e91e63; color: white; font-weight: bold;">üéØ LEADS</button>
            <button class="tab" onclick="switchTab('images')" style="background: #9c27b0; color: white; font-weight: bold;">üì∏ IMAGES</button>
            <button class="tab" onclick="switchTab('flight-logs')" style="background: #ff6f00; color: white;">‚úàÔ∏è Flight Logs</button>
            <button class="tab" onclick="switchTab('email-intelligence')" style="background: #1976d2; color: white;">üìß Email Intelligence</button>
            <button class="tab" onclick="switchTab('financial-tracker')" style="background: #4caf50; color: white;">üí∞ Financial Tracker</button>
            <button class="tab" onclick="switchTab('timeline')" style="background: #9c27b0; color: white;">üìÖ Timeline</button>
            <button class="tab" onclick="window.location.href='/mcp'" style="background: #00acc1; color: white; font-weight: bold;">üîß MCP TOOLS</button>
            <button class="tab" onclick="window.location.href='/graph'" style="background: #7c4dff; color: white; font-weight: bold;">üï∏Ô∏è KNOWLEDGE GRAPH</button>
            <button class="tab" onclick="switchTab('advanced-search')">üîç Advanced</button>
            <button class="tab" onclick="switchTab('kwic')">üìä KWIC</button>
            <button class="tab" onclick="switchTab('cooccurrence')">üï∏Ô∏è Matrix</button>
            <button class="tab" onclick="switchTab('anomalies')">‚ö†Ô∏è Anomalies</button>
            <button class="tab" onclick="switchTab('geomap')">üó∫Ô∏è Map</button>
            <button class="tab" onclick="switchTab('documents')">Documents</button>
            <button class="tab" onclick="switchTab('images')">Images</button>
            <button class="tab" onclick="switchTab('entities')">Entities</button>
            <button class="tab" onclick="switchTab('network')">Network</button>
            <button class="tab" onclick="switchTab('timeline')">Timeline</button>
        </div>

        <div id="upload-tab" class="tab-content active">
            <h2 style="margin-bottom: 20px;">Upload Documents</h2>
            <div class="upload-zone" id="upload-zone">
                <div style="font-size: 48px; margin-bottom: 20px;">üìÅ</div>
                <h3>Drop .txt, .pdf, or .jpg files here</h3>
                <p style="color: #999; margin-top: 10px;">or choose upload method:</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                    <button onclick="document.getElementById('file-input').click()" style="padding: 10px 20px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">Select Files</button>
                    <button onclick="document.getElementById('folder-input').click()" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">Select Folder</button>
                </div>
                <input type="file" id="file-input" multiple accept=".txt,.jpg,.jpeg,.pdf" style="display: none;">
                <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">
            </div>
            <div id="upload-status" style="margin-top: 20px;"></div>
        </div>

        <div id="search-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üîç Smart Search <span style="font-size: 14px; background: #2196f3; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold;">AI-POWERED</span></h2>

            <!-- Search Mode Selector -->
            <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <label style="color: #aaa; font-weight: bold;">Search Mode:</label>
                    <div style="display: flex; gap: 10px;">
                        <button id="mode-keyword" onclick="setSearchMode('keyword')" style="padding: 10px 20px; background: #555; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            üìù Keyword
                        </button>
                        <button id="mode-semantic" onclick="setSearchMode('semantic')" class="active" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            üß† Semantic (AI)
                        </button>
                        <button id="mode-hybrid" onclick="setSearchMode('hybrid')" style="padding: 10px 20px; background: #555; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            ‚ö° Hybrid
                        </button>
                    </div>
                </div>

                <div id="search-mode-description" style="color: #888; font-size: 13px; padding: 10px; background: #1a1a1a; border-radius: 4px;">
                    <strong style="color: #2196f3;">Semantic Search:</strong> Finds documents by meaning, not just exact keywords. Try: "evidence of trafficking", "payments to young women", "meetings at the mansion"
                </div>
            </div>

            <!-- Search Input -->
            <input type="text" class="search-box" id="search-input" placeholder="Try: 'flights to the island', 'suspicious financial activity', 'witness testimonies'..." onkeypress="if(event.key==='Enter') performSmartSearch()">

            <!-- Search Actions -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="performSmartSearch()" style="flex: 1; padding: 15px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                    üîç Search
                </button>
                <button onclick="showSemanticSearchSetup()" style="padding: 15px 20px; background: #555; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ‚öôÔ∏è Setup
                </button>
            </div>

            <!-- Search Stats -->
            <div id="search-stats" style="display: none; background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="color: #888;">Embeddings: </span>
                        <span id="embeddings-count" style="color: #2196f3; font-weight: bold;">0</span>
                        <span style="color: #888;"> / </span>
                        <span id="documents-count" style="color: #fff;">0</span>
                        <span style="color: #888;"> documents</span>
                    </div>
                    <div style="color: #4caf50; font-weight: bold;">
                        <span id="coverage-percentage">0</span>% Ready
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            <div id="search-results"></div>
        </div>

        <div id="ai-journalist-tab" class="tab-content">
            <h2 style="color: #f50057; margin-bottom: 15px;">üéØ AI Journalist Assistant <span style="font-size: 14px; background: #4caf50; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold;">v2.0 FIXED</span></h2>
            <p style="color: #666; margin-bottom: 25px;">Ask questions in natural language. AI analyzes 2,910 documents to provide investigative insights with evidence.</p>

            <div style="margin-bottom: 30px;">
                <input type="text" id="journalist-query-input" placeholder="Ask anything: 'How are Trump and Epstein connected?', 'What flights did Clinton take?', 'Find contradictions about the island'..." style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #f50057; border-radius: 8px; margin-bottom: 15px;">
                <button onclick="askJournalistQuestion()" style="padding: 15px 30px; background: #f50057; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; width: 100%;">üîç Investigate</button>
            </div>

            <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #666;">EXAMPLE QUERIES (click to try):</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="document.getElementById('journalist-query-input').value='How are Donald Trump and Jeffrey Epstein connected?'; askJournalistQuestion();" style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: left; font-size: 13px;">üîó Trump & Epstein connection</button>
                    <button onclick="document.getElementById('journalist-query-input').value='What flights did Bill Clinton take?'; askJournalistQuestion();" style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: left; font-size: 13px;">‚úàÔ∏è Clinton flight logs</button>
                    <button onclick="document.getElementById('journalist-query-input').value='Find contradictions about the island'; askJournalistQuestion();" style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: left; font-size: 13px;">‚ö†Ô∏è Island contradictions</button>
                    <button onclick="document.getElementById('journalist-query-input').value='What financial transactions involve Ghislaine Maxwell?'; askJournalistQuestion();" style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: left; font-size: 13px;">üí∞ Maxwell finances</button>
                    <button onclick="document.getElementById('journalist-query-input').value='Timeline of events involving Prince Andrew'; askJournalistQuestion();" style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: left; font-size: 13px;">üìÖ Prince Andrew timeline</button>
                    <button onclick="document.getElementById('journalist-query-input').value='Evidence involving victims'; askJournalistQuestion();" style="padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: left; font-size: 13px;">üö® Victim evidence</button>
                </div>
            </div>

            <div id="journalist-loading" style="display: none; text-align: center; padding: 40px;">
                <div class="loading-spinner"></div>
                <p style="color: #666; margin-top: 20px;">AI analyzing documents...</p>
            </div>

            <div id="journalist-results" style="display: none;"></div>
        </div>

        <div id="documents-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">Text Documents</h2>
            <div id="documents-list" class="document-list"></div>
        </div>

        <div id="images-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">Image Gallery</h2>
            <div id="images-gallery" class="gallery"></div>
        </div>

        <div id="entities-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">Extracted Entities</h2>
            <div id="entities-list" class="entity-grid"></div>
        </div>

        <div id="network-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">Relationship Network</h2>
            <div id="network-container"></div>
        </div>

        <div id="timeline-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">Timeline</h2>
            <div id="timeline-list" class="timeline"></div>
        </div>

        <div id="advanced-search-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üîç Advanced Search</h2>
            <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <input type="text" class="search-box" id="advanced-search-input" placeholder="Try: Epstein AND Maxwell, &quot;flight&quot; NEAR/10 &quot;island&quot;, NOT Clinton">
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="insertOperator(' AND ')" style="padding: 8px 15px; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">AND</button>
                    <button onclick="insertOperator(' OR ')" style="padding: 8px 15px; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">OR</button>
                    <button onclick="insertOperator(' NOT ')" style="padding: 8px 15px; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">NOT</button>
                    <button onclick="insertOperator(' NEAR/10 ')" style="padding: 8px 15px; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">NEAR/10</button>
                    <button onclick="performAdvancedSearch()" style="padding: 8px 20px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Search</button>
                </div>
            </div>
            <div id="advanced-search-results"></div>
        </div>

        <div id="kwic-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üìä KWIC - Keyword in Context</h2>
            <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <input type="text" class="search-box" id="kwic-input" placeholder="Enter keyword to see all occurrences with context...">
                <div style="margin-top: 15px;">
                    <label style="color: #999;">Context words: </label>
                    <input type="number" id="kwic-context" value="10" min="5" max="50" style="width: 80px; padding: 5px; background: #1a1a1a; border: 1px solid #555; color: white; border-radius: 4px;">
                    <button onclick="performKWIC()" style="padding: 8px 20px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Analyze</button>
                </div>
            </div>
            <div id="kwic-results"></div>
        </div>

        <div id="cooccurrence-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üï∏Ô∏è Co-Occurrence Matrix</h2>
            <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <label style="color: #999;">Minimum co-occurrences:</label>
                    <input type="number" id="cooccur-min" value="3" min="1" max="50" style="width: 80px; padding: 8px; background: #1a1a1a; border: 1px solid #555; color: white; border-radius: 4px;">
                    <button onclick="loadCooccurrence()" style="padding: 8px 20px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">Generate Matrix</button>
                </div>
            </div>
            <div id="cooccurrence-viz" style="background: #1a1a1a; padding: 20px; border-radius: 8px; min-height: 400px;"></div>
        </div>

        <div id="anomalies-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚ö†Ô∏è Anomalous Documents</h2>
            <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: #999; margin-bottom: 15px;">Documents with unusual characteristics (abnormal length, heavy redactions, unusual entity patterns)</p>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <label style="color: #999;">Anomaly threshold:</label>
                    <input type="number" id="anomaly-threshold" value="2.0" min="0.5" max="5" step="0.5" style="width: 80px; padding: 8px; background: #1a1a1a; border: 1px solid #555; color: white; border-radius: 4px;">
                    <button onclick="loadAnomalies()" style="padding: 8px 20px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">Detect Anomalies</button>
                </div>
            </div>
            <div id="anomalies-list"></div>
        </div>

        <div id="geomap-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">üó∫Ô∏è Geographic Heat Map</h2>
            <div id="geomap-container" style="background: #1a1a1a; padding: 20px; border-radius: 8px; min-height: 600px;">
                <div id="map" style="width: 100%; height: 550px; background: #2d2d2d; border-radius: 4px;"></div>
            </div>
        </div>

        <div id="flight-logs-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #ff6f00;">‚úàÔ∏è Flight Log Intelligence</h2>
            <p style="color: #999; margin-bottom: 20px;">Parse and analyze flight manifests to track passenger movements, identify suspicious travel patterns, and detect minors traveling with adults.</p>

            <div class="stats" style="margin-bottom: 30px;">
                <div class="stat-card" style="border-left-color: #ff6f00;">
                    <div class="stat-number" id="flight-count">0</div>
                    <div class="stat-label">Total Flights</div>
                </div>
                <div class="stat-card" style="border-left-color: #2196f3;">
                    <div class="stat-number" id="passenger-count">0</div>
                    <div class="stat-label">Unique Passengers</div>
                </div>
                <div class="stat-card" style="border-left-color: #d32f2f;">
                    <div class="stat-number" id="minor-count">0</div>
                    <div class="stat-label">Minor Passengers (RED FLAG)</div>
                </div>
                <div class="stat-card" style="border-left-color: #4caf50;">
                    <div class="stat-number" id="route-count">0</div>
                    <div class="stat-label">Unique Routes</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #ff6f00;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üö® Minor Travel Alerts</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Find minors traveling without parents - CRITICAL EVIDENCE</p>
                    <button onclick="loadMinorAlerts()" style="width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">View Alerts</button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üë§ Passenger History</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Track all flights for a specific person</p>
                    <input type="text" id="flight-passenger-name" placeholder="Passenger name" style="width: 100%; padding: 10px; margin-bottom: 10px; background: #1a1a1a; border: 1px solid #3d3d3d; color: #fff; border-radius: 4px;">
                    <button onclick="loadPassengerHistory()" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">View History</button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üîÅ Frequent Flyers</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Passengers with most flights - identify key players</p>
                    <button onclick="loadFrequentFlyers()" style="width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">View Top Flyers</button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üï∏Ô∏è Co-Travel Network</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Who flew with whom - build passenger networks</p>
                    <button onclick="loadCotravelNetwork()" style="width: 100%; padding: 12px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">View Network</button>
                </div>
            </div>

            <div id="flight-results" style="background: #2d2d2d; padding: 20px; border-radius: 8px; display: none;">
                <h3 style="color: #fff; margin-bottom: 15px;">Results</h3>
                <div id="flight-results-content"></div>
            </div>
        </div>

        <div id="email-intelligence-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #1976d2;">üìß Email Intelligence System</h2>

            <div class="stats" style="margin-bottom: 30px;">
                <div class="stat-card" style="border-left-color: #1976d2;">
                    <div class="stat-number" id="email-count">0</div>
                    <div class="stat-label">Total Emails</div>
                </div>
                <div class="stat-card" style="border-left-color: #d32f2f;">
                    <div class="stat-number" id="suspicious-email-count">0</div>
                    <div class="stat-label">Suspicious Emails</div>
                </div>
                <div class="stat-card" style="border-left-color: #ff9800;">
                    <div class="stat-number" id="email-thread-count">0</div>
                    <div class="stat-label">Email Threads</div>
                </div>
                <div class="stat-card" style="border-left-color: #f44336;">
                    <div class="stat-number" id="minor-thread-count">0</div>
                    <div class="stat-label">Threads Mentioning Minors</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #d32f2f;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üö® Suspicious Emails</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Emails flagged for suspicious keywords, minors, secrecy, payments.</p>
                    <button onclick="loadSuspiciousEmails()" style="width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        View Suspicious Emails
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üßµ High-Priority Threads</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Email conversations with multiple red flags.</p>
                    <button onclick="loadHighPriorityThreads()" style="width: 100%; padding: 12px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        View Priority Threads
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #1976d2;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üîç Search Emails</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Search through all email content and subjects.</p>
                    <input type="text" id="email-search-query" placeholder="Enter search term..." style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 6px; margin-bottom: 10px;">
                    <button onclick="searchEmails()" style="width: 100%; padding: 12px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Search Emails
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üîÑ Reconstruct Threads</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Rebuild email conversation threads and contact networks.</p>
                    <button onclick="reconstructThreads()" style="width: 100%; padding: 12px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Reconstruct All Threads
                    </button>
                </div>
            </div>

            <div id="email-results" style="background: #2d2d2d; padding: 20px; border-radius: 8px; display: none;">
                <h3 style="color: #fff; margin-bottom: 15px;">Results</h3>
                <div id="email-results-content"></div>
            </div>
        </div>

        <div id="financial-tracker-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #4caf50;">üí∞ Financial Transaction Tracker</h2>

            <div class="stats" style="margin-bottom: 30px;">
                <div class="stat-card" style="border-left-color: #4caf50;">
                    <div class="stat-number" id="transaction-count">0</div>
                    <div class="stat-label">Total Transactions</div>
                </div>
                <div class="stat-card" style="border-left-color: #d32f2f;">
                    <div class="stat-number" id="suspicious-transaction-count">0</div>
                    <div class="stat-label">Suspicious Transactions</div>
                </div>
                <div class="stat-card" style="border-left-color: #ff9800;">
                    <div class="stat-number" id="pattern-count">0</div>
                    <div class="stat-label">Suspicious Patterns</div>
                </div>
                <div class="stat-card" style="border-left-color: #9c27b0;">
                    <div class="stat-number" id="financial-entity-count">0</div>
                    <div class="stat-label">Financial Entities</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #d32f2f;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üö® Suspicious Transactions</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Large cash, offshore transfers, structuring, hush money.</p>
                    <button onclick="loadSuspiciousTransactions()" style="width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        View Suspicious Transactions
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üìä Detected Patterns</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Structuring, money laundering, repeated payments.</p>
                    <button onclick="loadFinancialPatterns()" style="width: 100%; padding: 12px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        View Patterns
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üí∏ Money Flow Network</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Track who paid whom and how much.</p>
                    <input type="text" id="financial-entity-name" placeholder="Entity name (optional)..." style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 6px; margin-bottom: 10px;">
                    <button onclick="loadMoneyFlows()" style="width: 100%; padding: 12px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        View Money Flows
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üîç Detect New Patterns</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Analyze all transactions for suspicious patterns.</p>
                    <button onclick="detectPatterns()" style="width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Run Pattern Detection
                    </button>
                </div>
            </div>

            <div id="financial-results" style="background: #2d2d2d; padding: 20px; border-radius: 8px; display: none;">
                <h3 style="color: #fff; margin-bottom: 15px;">Results</h3>
                <div id="financial-results-content"></div>
            </div>
        </div>

        <div id="timeline-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #9c27b0;">üìÖ Master Timeline</h2>

            <div class="stats" style="margin-bottom: 30px;">
                <div class="stat-card" style="border-left-color: #9c27b0;">
                    <div class="stat-number" id="timeline-event-count">0</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card" style="border-left-color: #d32f2f;">
                    <div class="stat-number" id="timeline-suspicious-count">0</div>
                    <div class="stat-label">Suspicious Events</div>
                </div>
                <div class="stat-card" style="border-left-color: #ff9800;">
                    <div class="stat-number" id="timeline-cluster-count">0</div>
                    <div class="stat-label">Event Clusters</div>
                </div>
                <div class="stat-card" style="border-left-color: #4fc3f7;">
                    <div class="stat-number" id="timeline-date-range">-</div>
                    <div class="stat-label">Date Range</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üîÑ Rebuild Timeline</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Rebuild from all sources: flights, emails, transactions.</p>
                    <button onclick="rebuildTimeline()" style="width: 100%; padding: 12px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Rebuild Timeline
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üìä View All Events</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Chronological view of all events.</p>
                    <button onclick="loadAllTimelineEvents()" style="width: 100%; padding: 12px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        View Timeline
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #d32f2f;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üö® Suspicious Events Only</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Show only high-suspicion events.</p>
                    <button onclick="loadSuspiciousTimelineEvents()" style="width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        View Suspicious Events
                    </button>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üîç Detect Clusters</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Find groups of related events.</p>
                    <button onclick="detectClusters()" style="width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Detect Clusters
                    </button>
                </div>
            </div>

            <div id="timeline-results" style="background: #2d2d2d; padding: 20px; border-radius: 8px; display: none;">
                <h3 style="color: #fff; margin-bottom: 15px;">Timeline</h3>
                <div id="timeline-results-content"></div>
            </div>
        </div>

        <div id="ai-investigation-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #d32f2f;">ü§ñ AI-Powered Investigation</h2>
            <p style="color: #999; margin-bottom: 30px;">Use Claude AI to analyze documents, uncover crimes, build criminal networks, and generate investigative leads.</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #d32f2f;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üìä Investigation Report</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Comprehensive AI analysis of all documents identifying crimes, suspects, victims, and evidence.</p>
                    <button onclick="generateAIReport()" style="width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Generate Report</button>
                    <div id="ai-report-loading" style="display: none; margin-top: 10px; color: #999; text-align: center;">
                        <div style="border: 3px solid #333; border-top: 3px solid #d32f2f; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto;"></div>
                        Analyzing documents...
                    </div>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üìÑ Analyze Document</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Deep AI analysis of a specific document for crimes, victims, and evidence.</p>
                    <input type="number" id="ai-doc-id" placeholder="Document ID" style="width: 100%; padding: 10px; margin-bottom: 10px; background: #1a1a1a; border: 1px solid #3d3d3d; color: #fff; border-radius: 4px;">
                    <button onclick="analyzeAIDocument()" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Analyze</button>
                    <div id="ai-doc-loading" style="display: none; margin-top: 10px; color: #999; text-align: center;">
                        <div style="border: 3px solid #333; border-top: 3px solid #2196f3; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto;"></div>
                        Analyzing document...
                    </div>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üï∏Ô∏è Relationship Network</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">AI analysis of criminal networks, facilitators, and suspicious connections.</p>
                    <input type="text" id="ai-entity" placeholder="Entity name (optional)" style="width: 100%; padding: 10px; margin-bottom: 10px; background: #1a1a1a; border: 1px solid #3d3d3d; color: #fff; border-radius: 4px;">
                    <button onclick="analyzeAINetwork()" style="width: 100%; padding: 12px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Analyze Network</button>
                    <div id="ai-network-loading" style="display: none; margin-top: 10px; color: #999; text-align: center;">
                        <div style="border: 3px solid #333; border-top: 3px solid #ff9800; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto;"></div>
                        Building network...
                    </div>
                </div>

                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h3 style="color: #fff; margin-bottom: 10px;">üö® Suspicious Patterns</h3>
                    <p style="color: #999; font-size: 14px; margin-bottom: 15px;">Auto-detect documents with suspicious keywords and patterns.</p>
                    <button onclick="findAIPatterns()" style="width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Scan Documents</button>
                    <div id="ai-patterns-loading" style="display: none; margin-top: 10px; color: #999; text-align: center;">
                        <div style="border: 3px solid #333; border-top: 3px solid #4caf50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto;"></div>
                        Scanning for patterns...
                    </div>
                </div>
            </div>

            <div id="ai-results" style="background: #2d2d2d; padding: 20px; border-radius: 8px; display: none;">
                <h3 style="color: #fff; margin-bottom: 15px;">Results</h3>
                <div id="ai-results-content"></div>
            </div>
        </div>

        <div id="leads-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #e91e63;">üéØ Investigation Leads <span style="font-size: 14px; background: #4caf50; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold;">AI-POWERED</span></h2>
            <p style="color: #999; margin-bottom: 30px;">AI-scored and prioritized investigative leads from contradictions, suspicious emails, flight anomalies, financial patterns, and network analysis.</p>

            <div class="stats" style="margin-bottom: 30px;">
                <div class="stat-card" style="border-left-color: #e91e63;">
                    <div class="stat-number" id="leads-total">0</div>
                    <div class="stat-label">Total Leads</div>
                </div>
                <div class="stat-card" style="border-left-color: #d32f2f;">
                    <div class="stat-number" id="leads-high-priority">0</div>
                    <div class="stat-label">High Priority</div>
                </div>
                <div class="stat-card" style="border-left-color: #ff9800;">
                    <div class="stat-number" id="leads-investigating">0</div>
                    <div class="stat-label">Investigating</div>
                </div>
                <div class="stat-card" style="border-left-color: #4caf50;">
                    <div class="stat-number" id="leads-resolved">0</div>
                    <div class="stat-label">Resolved</div>
                </div>
            </div>

            <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="initializeLeads()" style="padding: 12px 20px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        1. Initialize System
                    </button>
                    <button onclick="generateLeads()" style="padding: 12px 20px; background: #e91e63; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        2. Generate Leads
                    </button>
                    <button onclick="loadLeads()" style="padding: 12px 20px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Refresh
                    </button>
                </div>

                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <label style="color: #aaa;">Filter:</label>
                    <select id="lead-status-filter" onchange="loadLeads()" style="padding: 8px 12px; background: #1a1a1a; border: 1px solid #3d3d3d; color: white; border-radius: 4px;">
                        <option value="">All Status</option>
                        <option value="new">New</option>
                        <option value="investigating">Investigating</option>
                        <option value="resolved">Resolved</option>
                    </select>
                    <select id="lead-type-filter" onchange="loadLeads()" style="padding: 8px 12px; background: #1a1a1a; border: 1px solid #3d3d3d; color: white; border-radius: 4px;">
                        <option value="">All Types</option>
                        <option value="contradiction">Contradictions</option>
                        <option value="suspicious_email">Suspicious Emails</option>
                        <option value="flight_anomaly">Flight Anomalies</option>
                        <option value="financial_suspicious">Financial</option>
                        <option value="network_analysis">Network Analysis</option>
                    </select>
                </div>
            </div>

            <div id="leads-results" style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
                <div style="text-align: center; padding: 40px; color: #999;">
                    Click "Generate Leads" to analyze all evidence and create prioritized investigation leads
                </div>
            </div>
        </div>

        <!-- IMAGES TAB - AI-POWERED VISUAL INTELLIGENCE -->
        <div id="images-tab" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #9c27b0;">üì∏ Visual Intelligence <span style="font-size: 14px; background: #4caf50; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold;">AI-POWERED</span></h2>
            <p style="color: #999; margin-bottom: 30px;">AI-powered image analysis: face detection, EXIF metadata extraction, location tracking, scene classification, and suspicious image flagging.</p>

            <div class="stats" style="margin-bottom: 30px;">
                <div class="stat-card" style="border-left-color: #9c27b0;">
                    <div class="stat-number" id="images-analyzed">0</div>
                    <div class="stat-label">Images Analyzed</div>
                </div>
                <div class="stat-card" style="border-left-color: #2196f3;">
                    <div class="stat-number" id="images-with-faces">0</div>
                    <div class="stat-label">With Faces</div>
                </div>
                <div class="stat-card" style="border-left-color: #ff9800;">
                    <div class="stat-number" id="images-suspicious">0</div>
                    <div class="stat-label">Suspicious</div>
                </div>
                <div class="stat-card" style="border-left-color: #4caf50;">
                    <div class="stat-number" id="images-with-location">0</div>
                    <div class="stat-label">GPS Location</div>
                </div>
                <div class="stat-card" style="border-left-color: #f44336;">
                    <div class="stat-number" id="total-faces-detected">0</div>
                    <div class="stat-label">Total Faces</div>
                </div>
            </div>

            <div style="background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="initializeVisualIntelligence()" style="padding: 12px 20px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        1. Initialize System
                    </button>
                    <button onclick="analyzeAllImages()" style="padding: 12px 20px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        2. Analyze All Images
                    </button>
                    <button onclick="findSimilarImages()" style="padding: 12px 20px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Find Similar/Duplicates
                    </button>
                    <button onclick="loadAnalyzedImages()" style="padding: 12px 20px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Refresh
                    </button>
                </div>

                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <label style="color: #aaa;">Filter:</label>
                    <label style="color: #ccc; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="filter-has-faces" onchange="loadAnalyzedImages()">
                        Has Faces
                    </label>
                    <label style="color: #ccc; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="filter-has-location" onchange="loadAnalyzedImages()">
                        Has GPS Location
                    </label>
                    <label style="color: #ccc; display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="filter-suspicious" onchange="loadAnalyzedImages()">
                        Suspicious Only
                    </label>
                    <select id="scene-type-filter" onchange="loadAnalyzedImages()" style="padding: 8px 12px; background: #1a1a1a; border: 1px solid #3d3d3d; color: white; border-radius: 4px;">
                        <option value="">All Scenes</option>
                        <option value="outdoor/sky">Outdoor/Sky</option>
                        <option value="outdoor/vegetation">Outdoor/Vegetation</option>
                        <option value="indoor/bright">Indoor/Bright</option>
                        <option value="indoor/dark">Indoor/Dark</option>
                        <option value="document/scan">Document/Scan</option>
                    </select>
                </div>
            </div>

            <div id="images-results" style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
                <div style="text-align: center; padding: 40px; color: #999;">
                    Click "Analyze All Images" to process photos with AI face detection, metadata extraction, and suspicious content flagging
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script>
        // State
        let currentTab = 'upload';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupUpload();
            setupSearch();
            loadStats();
        });

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;

            // Load data for tab
            if (tabName === 'documents') loadDocuments();
            if (tabName === 'images') loadImages();
            if (tabName === 'entities') loadEntities();
            if (tabName === 'network') loadNetwork();
            if (tabName === 'timeline') loadTimeline();
            if (tabName === 'advanced-search') setupAdvancedSearch();
            if (tabName === 'kwic') setupKWIC();
            if (tabName === 'cooccurrence') loadCooccurrence();
            if (tabName === 'anomalies') loadAnomalies();
            if (tabName === 'geomap') loadGeoMap();
            if (tabName === 'ai-investigation') generateAIReport();
            if (tabName === 'flight-logs') loadFlightStats();
            if (tabName === 'email-intelligence') loadEmailStats();
            if (tabName === 'financial-tracker') loadFinancialStats();
        }

        // Upload functionality
        function setupUpload() {
            const zone = document.getElementById('upload-zone');
            const input = document.getElementById('file-input');
            const folderInput = document.getElementById('folder-input');

            // Don't trigger click on zone anymore (buttons handle it)
            // zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            input.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            folderInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        async function handleFiles(files) {
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            const status = document.getElementById('upload-status');
            status.innerHTML = '<div class="loading">Uploading and processing files...</div>';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    status.innerHTML = `<div style="color: #4caf50; padding: 15px; background: #1a3a1a; border-radius: 8px;">
                        Successfully uploaded ${result.files.length} file(s)
                    </div>`;
                    loadStats();
                    setTimeout(() => status.innerHTML = '', 3000);
                } else {
                    status.innerHTML = `<div style="color: #f44336; padding: 15px; background: #3a1a1a; border-radius: 8px;">
                        Error: ${result.error}
                    </div>`;
                }
            } catch (error) {
                status.innerHTML = `<div style="color: #f44336; padding: 15px; background: #3a1a1a; border-radius: 8px;">
                    Upload failed: ${error.message}
                </div>`;
            }
        }

        // Search functionality
        function setupSearch() {
            const input = document.getElementById('search-input');
            let timeout;

            input.addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => performSearch(e.target.value), 300);
            });
        }

        // Semantic Search Variables
        let currentSearchMode = 'semantic';

        function setSearchMode(mode) {
            currentSearchMode = mode;

            // Update button styles
            document.getElementById('mode-keyword').style.background = mode === 'keyword' ? '#2196f3' : '#555';
            document.getElementById('mode-semantic').style.background = mode === 'semantic' ? '#2196f3' : '#555';
            document.getElementById('mode-hybrid').style.background = mode === 'hybrid' ? '#2196f3' : '#555';

            // Update description
            const descriptions = {
                'keyword': '<strong style="color: #fff;">Keyword Search:</strong> Traditional exact-match search. Fastest, but may miss relevant documents.',
                'semantic': '<strong style="color: #2196f3;">Semantic Search:</strong> Finds documents by meaning, not just exact keywords. Try: "evidence of trafficking", "payments to young women", "meetings at the mansion"',
                'hybrid': '<strong style="color: #ff9800;">Hybrid Search:</strong> Combines keyword matching with AI semantic understanding for best results.'
            };
            document.getElementById('search-mode-description').innerHTML = descriptions[mode];
        }

        async function performSmartSearch() {
            const query = document.getElementById('search-input').value;
            const container = document.getElementById('search-results');

            if (!query.trim()) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>Enter a search term to begin</p></div>';
                return;
            }

            container.innerHTML = '<div class="loading">üîç Searching...</div>';

            try {
                let endpoint, data;

                if (currentSearchMode === 'semantic') {
                    const response = await fetch(`/api/semantic-search/search?q=${encodeURIComponent(query)}&limit=20`);
                    data = await response.json();
                } else if (currentSearchMode === 'hybrid') {
                    const response = await fetch(`/api/semantic-search/hybrid?q=${encodeURIComponent(query)}&limit=20`);
                    data = await response.json();
                } else {
                    const response = await fetch(`/search?q=${encodeURIComponent(query)}`);
                    data = await response.json();
                }

                if (data.error) {
                    if (data.error.includes('no such table') || data.error.includes('embeddings')) {
                        container.innerHTML = `
                            <div style="background: #2d2d2d; padding: 30px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                                <h3 style="color: #ff9800; margin-bottom: 10px;">Semantic Search Not Initialized</h3>
                                <p style="color: #aaa; margin-bottom: 20px;">You need to set up semantic search first. This is a one-time process.</p>
                                <button onclick="showSemanticSearchSetup()" style="padding: 12px 24px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    Setup Semantic Search
                                </button>
                            </div>
                        `;
                        return;
                    }
                    throw new Error(data.error);
                }

                const results = data.results || [];

                if (results.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No results found</p></div>';
                    return;
                }

                // Display results with relevance scores
                container.innerHTML = '<div class="document-list">' + results.map((doc, index) => {
                    const relevance = doc.relevance_percentage || doc.similarity_score * 100 || 50;
                    const relevanceColor = relevance >= 70 ? '#4caf50' : relevance >= 50 ? '#ff9800' : '#999';

                    return `
                        <div class="document-item" onclick="viewDocument(${doc.doc_id})" style="position: relative;">
                            <div style="position: absolute; top: 15px; right: 15px; background: ${relevanceColor}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                ${Math.round(relevance)}% Match
                            </div>
                            <div class="doc-title">${doc.filename}</div>
                            <div class="doc-meta">
                                ${new Date(doc.uploaded_date).toLocaleDateString()}
                                ${currentSearchMode === 'hybrid' ?
                                    ` | Semantic: ${Math.round((doc.semantic_score || 0) * 100)}% | Keyword: ${Math.round((doc.keyword_score || 0) * 100)}%`
                                    : ''}
                            </div>
                            <div class="snippet">${doc.content ? doc.content.substring(0, 300) + '...' : 'No preview available'}</div>
                        </div>
                    `;
                }).join('') + '</div>';
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336; background: #2d2d2d; padding: 20px; border-radius: 8px;">
                    <strong>Search failed:</strong> ${error.message}
                    <br><br>
                    <button onclick="showSemanticSearchSetup()" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Setup Semantic Search
                    </button>
                </div>`;
            }
        }

        async function showSemanticSearchSetup() {
            const container = document.getElementById('search-results');

            container.innerHTML = `
                <div style="background: #2d2d2d; padding: 30px; border-radius: 8px;">
                    <h3 style="color: #2196f3; margin-bottom: 15px;">üß† Semantic Search Setup</h3>
                    <p style="color: #aaa; margin-bottom: 20px;">
                        Semantic search uses AI to understand the meaning of your queries, not just match keywords.
                        This one-time setup will analyze all your documents and create AI embeddings.
                    </p>

                    <div style="background: #1a1a1a; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #888;">Status:</span>
                            <span id="setup-status" style="color: #ff9800; font-weight: bold;">Not Initialized</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #888;">Documents Ready:</span>
                            <span id="setup-progress" style="color: #2196f3; font-weight: bold;">0 / 0</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button id="init-btn" onclick="initSemanticSearch()" style="flex: 1; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            1. Initialize System
                        </button>
                        <button id="generate-btn" onclick="generateEmbeddings()" disabled style="flex: 1; padding: 12px; background: #555; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            2. Generate Embeddings
                        </button>
                    </div>

                    <div id="setup-log" style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; font-family: monospace; font-size: 12px; color: #4caf50; max-height: 200px; overflow-y: auto; display: none;"></div>
                </div>
            `;

            // Load current stats
            loadSemanticSearchStats();
        }

        async function initSemanticSearch() {
            const btn = document.getElementById('init-btn');
            const log = document.getElementById('setup-log');

            btn.disabled = true;
            btn.textContent = 'Initializing...';
            log.style.display = 'block';
            log.innerHTML = '> Initializing semantic search tables...\n';

            try {
                const response = await fetch('/api/semantic-search/init', { method: 'POST' });
                const data = await response.json();

                log.innerHTML += `> ‚úì ${data.message}\n`;
                document.getElementById('setup-status').textContent = 'Initialized';
                document.getElementById('setup-status').style.color = '#4caf50';

                // Enable next button
                document.getElementById('generate-btn').disabled = false;
                document.getElementById('generate-btn').style.background = '#2196f3';

                btn.textContent = '‚úì Initialized';
            } catch (error) {
                log.innerHTML += `> ‚úó Error: ${error.message}\n`;
                btn.disabled = false;
                btn.textContent = '1. Initialize System';
            }
        }

        async function generateEmbeddings() {
            const btn = document.getElementById('generate-btn');
            const log = document.getElementById('setup-log');

            btn.disabled = true;
            btn.textContent = 'Generating...';
            log.innerHTML += '\n> Generating embeddings for all documents...\n> This may take a few minutes...\n';

            try {
                const response = await fetch('/api/semantic-search/generate-embeddings', { method: 'POST' });
                const data = await response.json();

                log.innerHTML += `> ‚úì Processed: ${data.processed} documents\n`;
                if (data.failed > 0) {
                    log.innerHTML += `> ‚ö† Failed: ${data.failed} documents\n`;
                }
                log.innerHTML += `> ‚úì Semantic search is ready!\n`;

                document.getElementById('setup-status').textContent = 'Ready';
                document.getElementById('setup-status').style.color = '#4caf50';
                document.getElementById('setup-progress').textContent = `${data.processed} / ${data.total}`;

                btn.textContent = '‚úì Complete';
                btn.style.background = '#4caf50';

                // Show stats
                document.getElementById('search-stats').style.display = 'block';
                loadSemanticSearchStats();
            } catch (error) {
                log.innerHTML += `> ‚úó Error: ${error.message}\n`;
                btn.disabled = false;
                btn.textContent = '2. Generate Embeddings';
            }
        }

        async function loadSemanticSearchStats() {
            try {
                const response = await fetch('/api/semantic-search/stats');
                const stats = await response.json();

                document.getElementById('embeddings-count').textContent = stats.total_embeddings || 0;
                document.getElementById('documents-count').textContent = stats.total_documents || 0;
                document.getElementById('coverage-percentage').textContent = stats.coverage_percentage || 0;

                if (stats.coverage_percentage > 0) {
                    document.getElementById('search-stats').style.display = 'block';
                }

                if (document.getElementById('setup-progress')) {
                    document.getElementById('setup-progress').textContent = `${stats.total_embeddings} / ${stats.total_documents}`;
                }

                if (stats.coverage_percentage >= 100) {
                    if (document.getElementById('setup-status')) {
                        document.getElementById('setup-status').textContent = 'Ready';
                        document.getElementById('setup-status').style.color = '#4caf50';
                    }
                }
            } catch (error) {
                // Silently fail if not initialized
            }
        }

        async function performSearch(query) {
            const container = document.getElementById('search-results');

            if (!query.trim()) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>Enter a search term to begin</p></div>';
                return;
            }

            container.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const response = await fetch(`/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.results.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No results found</p></div>';
                    return;
                }

                container.innerHTML = '<div class="document-list">' + data.results.map(doc => `
                    <div class="document-item ${doc.type}" onclick="viewDocument(${doc.id})">
                        <div class="doc-title">${doc.filename}</div>
                        <div class="doc-meta">${new Date(doc.uploaded_date).toLocaleDateString()}</div>
                        <div class="snippet">${doc.snippet}</div>
                    </div>
                `).join('') + '</div>';
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336;">Search failed: ${error.message}</div>`;
            }
        }

        // Load semantic search stats when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadSemanticSearchStats();
        });

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();

                document.getElementById('stat-documents').textContent = data.text_documents.toLocaleString();
                document.getElementById('stat-images').textContent = data.images.toLocaleString();
                document.getElementById('stat-entities').textContent = data.entities.toLocaleString();
                document.getElementById('stat-contradictions').textContent = (data.contradictions || 0).toLocaleString();
            } catch (error) {
                console.error('Failed to load stats:', error);
            }

            // Load contradiction stats (fallback if not in main stats)
            try {
                const contradictionResponse = await fetch('/api/contradictions/stats');
                const contradictionData = await contradictionResponse.json();
                if (contradictionData.total_contradictions) {
                    document.getElementById('stat-contradictions').textContent = contradictionData.total_contradictions.toLocaleString();
                }
            } catch (error) {
                // Silently fail if contradictions haven't been initialized yet
            }
        }

        // Load documents
        async function loadDocuments() {
            const container = document.getElementById('documents-list');
            container.innerHTML = '<div class="loading">Loading documents...</div>';

            try {
                const response = await fetch('/documents?type=txt');
                const data = await response.json();

                if (data.documents.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No documents uploaded yet</p></div>';
                    return;
                }

                container.innerHTML = data.documents.map(doc => `
                    <div class="document-item txt" onclick="viewDocument(${doc.id})">
                        <div class="doc-title">${doc.filename}</div>
                        <div class="doc-meta">Uploaded: ${new Date(doc.uploaded_date).toLocaleDateString()}</div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336;">Failed to load documents: ${error.message}</div>`;
            }
        }

        // Load images
        async function loadImages() {
            const container = document.getElementById('images-gallery');
            container.innerHTML = '<div class="loading">Loading images...</div>';

            try {
                const response = await fetch('/documents?type=image');
                const data = await response.json();

                if (data.documents.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üñºÔ∏è</div><p>No images uploaded yet</p></div>';
                    return;
                }

                container.innerHTML = data.documents.map(doc => `
                    <div class="gallery-item" onclick="viewDocument(${doc.id})">
                        <img src="/documents/${doc.id}" alt="${doc.filename}">
                        <div class="gallery-caption">${doc.filename}</div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336;">Failed to load images: ${error.message}</div>`;
            }
        }

        // Load entities
        async function loadEntities() {
            const container = document.getElementById('entities-list');
            container.innerHTML = '<div class="loading">Loading entities...</div>';

            try {
                const response = await fetch('/entities');
                const data = await response.json();

                if (data.entities.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>No entities extracted yet</p></div>';
                    return;
                }

                container.innerHTML = data.entities.map(entity => `
                    <div class="entity-card">
                        <div class="entity-name">${entity.name}</div>
                        <span class="entity-type ${entity.type}">${entity.type}</span>
                        <div class="doc-meta">${entity.mentions} mention(s)</div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336;">Failed to load entities: ${error.message}</div>`;
            }
        }

        // Load network
        async function loadNetwork() {
            const container = document.getElementById('network-container');
            container.innerHTML = '<div class="loading">Building network graph...</div>';

            try {
                const response = await fetch('/network');
                const data = await response.json();

                if (data.nodes.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üï∏Ô∏è</div><p>No relationships to display yet</p></div>';
                    return;
                }

                const nodes = new vis.DataSet(data.nodes);
                const edges = new vis.DataSet(data.edges);

                const graphData = { nodes, edges };
                const options = {
                    nodes: {
                        shape: 'dot',
                        size: 20,
                        font: { size: 14, color: '#fff' },
                        borderWidth: 2,
                        color: {
                            border: '#d32f2f',
                            background: '#4caf50',
                            highlight: { border: '#fff', background: '#d32f2f' }
                        }
                    },
                    edges: {
                        width: 2,
                        color: { color: '#666', highlight: '#d32f2f' },
                        smooth: { type: 'continuous' }
                    },
                    physics: {
                        stabilization: { iterations: 200 },
                        barnesHut: { gravitationalConstant: -8000, springConstant: 0.001 }
                    }
                };

                container.innerHTML = '';
                new vis.Network(container, graphData, options);
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336;">Failed to load network: ${error.message}</div>`;
            }
        }

        // Load timeline
        async function loadTimeline() {
            const container = document.getElementById('timeline-list');
            container.innerHTML = '<div class="loading">Loading timeline...</div>';

            try {
                const response = await fetch('/timeline');
                const data = await response.json();

                if (data.events.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No timeline events yet</p></div>';
                    return;
                }

                container.innerHTML = data.events.map(event => `
                    <div class="timeline-item">
                        <div class="timeline-date">${event.date}</div>
                        <div class="doc-title">${event.filename}</div>
                        <div style="margin-top: 10px; color: #ccc;">${event.context}</div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336;">Failed to load timeline: ${error.message}</div>`;
            }
        }

        // View document
        async function viewDocument(docId) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modal-body');

            modalBody.innerHTML = '<div class="loading">Loading document...</div>';
            modal.classList.add('active');

            try {
                // Request JSON metadata with explicit Accept header
                const response = await fetch(`/documents/${docId}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const doc = await response.json();

                let content = `
                    <h2>${doc.filename}</h2>
                    <div class="doc-meta" style="margin-bottom: 20px;">
                        Uploaded: ${new Date(doc.uploaded_date).toLocaleDateString()}
                    </div>
                `;

                if (doc.entities && doc.entities.length > 0) {
                    content += `
                        <div style="margin-bottom: 20px;">
                            <strong>Entities mentioned:</strong><br>
                            ${doc.entities.map(e => `<span class="entity-type ${e.type}">${e.name}</span>`).join(' ')}
                        </div>
                    `;
                }

                // Handle different document types
                if (doc.type === 'txt') {
                    content += `<div class="doc-content">${doc.content}</div>`;
                } else if (doc.type && doc.type.startsWith('image/')) {
                    // Display image using the doc ID endpoint which serves the actual file
                    content += `<img src="/documents/${docId}" style="max-width: 100%; height: auto; border-radius: 8px;">`;
                } else {
                    content += `<div class="doc-content">${doc.content}</div>`;
                }

                modalBody.innerHTML = content;
            } catch (error) {
                modalBody.innerHTML = `<div style="color: #f44336;">Failed to load document: ${error.message}</div>`;
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Close modal on background click
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });

        // ====================================================================
        // ADVANCED INVESTIGATIVE FEATURES
        // ====================================================================

        // Advanced Search
        function setupAdvancedSearch() {
            const input = document.getElementById('advanced-search-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performAdvancedSearch();
            });
        }

        function insertOperator(operator) {
            const input = document.getElementById('advanced-search-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + operator + text.substring(end);
            input.focus();
        }

        async function performAdvancedSearch() {
            const query = document.getElementById('advanced-search-input').value;
            if (!query) return;

            const resultsDiv = document.getElementById('advanced-search-results');
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const response = await fetch('/api/advanced-search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query})
                });

                const data = await response.json();

                if (data.count === 0) {
                    resultsDiv.innerHTML = '<p style="color: #999;">No results found</p>';
                    return;
                }

                let html = `<p style="color: #999; margin-bottom: 15px;">Found ${data.count} results</p>`;
                html += '<div class="document-list">';

                data.results.forEach(result => {
                    html += `
                        <div class="document-item" onclick="showDocument(${result.id})">
                            <div class="document-title">${result.filename}</div>
                            <div class="document-snippet">${result.snippet}</div>
                            <div style="color: #666; font-size: 12px; margin-top: 5px;">${result.uploaded_date}</div>
                        </div>
                    `;
                });
                html += '</div>';

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<p style="color: #d32f2f;">Error performing search</p>';
            }
        }

        // KWIC Concordance
        function setupKWIC() {
            const input = document.getElementById('kwic-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performKWIC();
            });
        }

        async function performKWIC() {
            const keyword = document.getElementById('kwic-input').value;
            const context = document.getElementById('kwic-context').value;

            if (!keyword) return;

            const resultsDiv = document.getElementById('kwic-results');
            resultsDiv.innerHTML = '<div class="loading">Analyzing...</div>';

            try {
                const response = await fetch(`/api/kwic?keyword=${encodeURIComponent(keyword)}&context=${context}`);
                const data = await response.json();

                if (data.count === 0) {
                    resultsDiv.innerHTML = '<p style="color: #999;">No occurrences found</p>';
                    return;
                }

                let html = `<p style="color: #999; margin-bottom: 20px;">Found <strong>${data.count}</strong> occurrences of "${keyword}"</p>`;
                html += '<div style="background: #2d2d2d; padding: 15px; border-radius: 8px; max-height: 600px; overflow-y: auto;">';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="border-bottom: 2px solid #555;"><th style="padding: 10px; text-align: left;">Left Context</th><th style="padding: 10px; text-align: center; color: #d32f2f;">Keyword</th><th style="padding: 10px; text-align: left;">Right Context</th><th style="padding: 10px;">Document</th></tr>';

                data.results.slice(0, 200).forEach(result => {
                    html += `
                        <tr style="border-bottom: 1px solid #333;">
                            <td style="padding: 8px; text-align: right; color: #999;">${result.left_context}</td>
                            <td style="padding: 8px; text-align: center; color: #fff; font-weight: bold; background: #d32f2f22;">${result.keyword}</td>
                            <td style="padding: 8px; color: #999;">${result.right_context}</td>
                            <td style="padding: 8px; font-size: 11px;"><a href="#" onclick="showDocument(${result.doc_id}); return false;" style="color: #2196f3;">${result.filename}</a></td>
                        </tr>
                    `;
                });

                if (data.count > 200) {
                    html += `<tr><td colspan="4" style="padding: 15px; text-align: center; color: #999;">Showing first 200 of ${data.count} results</td></tr>`;
                }

                html += '</table></div>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<p style="color: #d32f2f;">Error performing analysis</p>';
            }
        }

        // Co-occurrence Matrix
        async function loadCooccurrence() {
            const min = document.getElementById('cooccur-min').value;
            const container = document.getElementById('cooccurrence-viz');
            container.innerHTML = '<div class="loading">Calculating co-occurrences...</div>';

            try {
                const response = await fetch(`/api/cooccurrence?type=person&min=${min}`);
                const data = await response.json();

                if (!data.cooccurrences || data.cooccurrences.length === 0) {
                    container.innerHTML = '<p style="color: #999;">No co-occurrences found at this threshold</p>';
                    return;
                }

                let html = `<p style="color: #999; margin-bottom: 20px;">Found ${data.cooccurrences.length} entity pairs that co-occur in documents</p>`;
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';

                data.cooccurrences.sort((a, b) => b.count - a.count).slice(0, 50).forEach(pair => {
                    const intensity = Math.min(pair.count / 10, 1);
                    const bgColor = `rgba(211, 47, 47, ${0.2 + intensity * 0.6})`;

                    html += `
                        <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; border-left: 4px solid #d32f2f;">
                            <div style="font-weight: bold; margin-bottom: 8px;">${pair.entity1} ‚Üî ${pair.entity2}</div>
                            <div style="color: #ccc; font-size: 14px;">${pair.count} documents</div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<p style="color: #d32f2f;">Error loading co-occurrence data</p>';
            }
        }

        // Anomalies
        async function loadAnomalies() {
            const threshold = document.getElementById('anomaly-threshold').value;
            const container = document.getElementById('anomalies-list');
            container.innerHTML = '<div class="loading">Detecting anomalies...</div>';

            try {
                const response = await fetch(`/api/anomalies?threshold=${threshold}`);
                const data = await response.json();

                if (data.count === 0) {
                    container.innerHTML = '<p style="color: #999;">No anomalies detected at this threshold</p>';
                    return;
                }

                let html = `<p style="color: #999; margin-bottom: 20px;">Found ${data.count} anomalous documents</p>`;
                html += '<div class="document-list">';

                data.anomalies.forEach(doc => {
                    let anomalyTags = [];
                    if (doc.word_count > 50000) anomalyTags.push('üî¥ Extremely Long');
                    if (doc.word_count < 50) anomalyTags.push('‚ö™ Very Short');
                    if (doc.has_redactions) anomalyTags.push(`‚¨õ ${doc.redaction_count} Redactions`);
                    if (doc.unique_entities > 20) anomalyTags.push(`üë• ${doc.unique_entities} Entities`);

                    html += `
                        <div class="document-item" onclick="showDocument(${doc.id})">
                            <div class="document-title">${doc.filename}</div>
                            <div style="margin: 8px 0;">
                                <span style="background: #d32f2f; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px;">Score: ${doc.anomaly_score}</span>
                                ${anomalyTags.map(tag => `<span style="background: #555; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px;">${tag}</span>`).join('')}
                            </div>
                            <div style="color: #999; font-size: 13px; margin-top: 5px;">
                                ${doc.word_count.toLocaleString()} words | ${doc.unique_entities} entities
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<p style="color: #d32f2f;">Error loading anomalies</p>';
            }
        }

        // Geographic Map
        let geoMap = null;

        async function loadGeoMap() {
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '<div style="width: 100%; height: 100%;"></div>';

            try {
                const response = await fetch('/api/geomap');
                const data = await response.json();

                if (data.count === 0) {
                    mapDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">No geocoded locations available</p>';
                    return;
                }

                // Initialize Leaflet map
                if (geoMap) {
                    geoMap.remove();
                }

                geoMap = L.map(mapDiv).setView([25.0, -40.0], 2);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(geoMap);

                // Add markers with circle size based on mentions
                data.locations.forEach(loc => {
                    const radius = Math.sqrt(loc.mentions) * 3;
                    const circle = L.circleMarker([loc.lat, loc.lng], {
                        radius: radius,
                        fillColor: '#d32f2f',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).addTo(geoMap);

                    circle.bindPopup(`
                        <div style="color: #000; padding: 10px;">
                            <strong style="font-size: 16px;">${loc.name}</strong><br>
                            <span style="color: #666;">${loc.mentions} mentions</span>
                        </div>
                    `);
                });

                // Fit bounds to show all markers
                const bounds = data.locations.map(loc => [loc.lat, loc.lng]);
                if (bounds.length > 0) {
                    geoMap.fitBounds(bounds, {padding: [50, 50]});
                }

            } catch (error) {
                mapDiv.innerHTML = '<p style="color: #d32f2f; padding: 20px;">Error loading map</p>';
                console.error(error);
            }
        }

        // AI Investigation Functions
        async function generateAIReport() {
            const loading = document.getElementById('ai-report-loading');
            const results = document.getElementById('ai-results');
            const resultsContent = document.getElementById('ai-results-content');

            loading.style.display = 'block';
            results.style.display = 'none';

            try {
                const response = await fetch('/api/ai/investigation-report');
                const data = await response.json();

                loading.style.display = 'none';
                results.style.display = 'block';

                let html = '<h2 style="color: #d32f2f; margin-bottom: 20px;">AI Investigation Report</h2>';

                if (data.error) {
                    html += `<p style="color: #d32f2f;">${data.error}</p><p style="color: #999; margin-top: 10px;">Make sure to set your ANTHROPIC_API_KEY environment variable and restart the Flask app.</p>`;
                } else {
                    if (data.executive_summary) {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 15px 0;"><strong style="color: #fff;">Executive Summary:</strong><br><span style="color: #999;">${data.executive_summary}</span></div>`;
                    }
                    if (data.documented_crimes && data.documented_crimes.length) {
                        html += '<h3 style="color: #d32f2f; margin-top: 20px;">Documented Crimes</h3><ul style="color: #999;">';
                        data.documented_crimes.forEach(crime => html += `<li style="margin: 8px 0;">${crime}</li>`);
                        html += '</ul>';
                    }
                    if (data.key_suspects && data.key_suspects.length) {
                        html += '<h3 style="color: #ff9800; margin-top: 20px;">Key Suspects</h3>';
                        data.key_suspects.forEach(suspect => {
                            html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #ff9800;">
                                <strong style="color: #fff;">${suspect.name || 'Unknown'}</strong><br>
                                <span style="color: #999;">Role: ${suspect.role || 'N/A'}<br>Evidence: ${suspect.evidence || 'N/A'}</span>
                            </div>`;
                        });
                    }
                    if (data.investigative_leads && data.investigative_leads.length) {
                        html += '<h3 style="color: #2196f3; margin-top: 20px;">Investigative Leads</h3><ul style="color: #999;">';
                        data.investigative_leads.forEach(lead => html += `<li style="margin: 8px 0;">${lead}</li>`);
                        html += '</ul>';
                    }
                    html += '<details style="margin-top: 20px;"><summary style="color: #fff; cursor: pointer;">View Full JSON</summary><pre style="background: #1a1a1a; padding: 15px; border-radius: 8px; overflow-x: auto; margin-top: 10px; color: #999;">' + JSON.stringify(data, null, 2) + '</pre></details>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                loading.style.display = 'none';
                results.style.display = 'block';
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function analyzeAIDocument() {
            const docId = document.getElementById('ai-doc-id').value;
            if (!docId) {
                alert('Please enter a document ID');
                return;
            }

            const loading = document.getElementById('ai-doc-loading');
            const results = document.getElementById('ai-results');
            const resultsContent = document.getElementById('ai-results-content');

            loading.style.display = 'block';
            results.style.display = 'none';

            try {
                const response = await fetch(`/api/ai/analyze-document/${docId}`, { method: 'POST' });
                const data = await response.json();

                loading.style.display = 'none';
                results.style.display = 'block';

                let html = `<h2 style="color: #2196f3; margin-bottom: 20px;">Document ${docId} Analysis</h2>`;

                if (data.error) {
                    html += `<p style="color: #d32f2f;">${data.error}</p>`;
                } else {
                    if (data.severity) {
                        const color = data.severity === 'high' ? '#d32f2f' : data.severity === 'medium' ? '#ff9800' : '#4caf50';
                        html += `<div style="display: inline-block; background: ${color}; color: white; padding: 5px 15px; border-radius: 5px; margin-bottom: 15px;">Severity: ${data.severity.toUpperCase()}</div>`;
                    }
                    if (data.executive_summary) {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 15px 0;"><strong style="color: #fff;">Summary:</strong><br><span style="color: #999;">${data.executive_summary}</span></div>`;
                    }
                    if (data.criminal_activity_found && data.criminal_activity_found.length) {
                        html += '<h3 style="color: #d32f2f; margin-top: 20px;">Criminal Activity Found</h3><ul style="color: #999;">';
                        data.criminal_activity_found.forEach(crime => html += `<li style="margin: 8px 0;">${crime}</li>`);
                        html += '</ul>';
                    }
                    if (data.key_evidence && data.key_evidence.length) {
                        html += '<h3 style="color: #2196f3; margin-top: 20px;">Key Evidence</h3><ul style="color: #999;">';
                        data.key_evidence.forEach(ev => html += `<li style="margin: 8px 0;">${ev}</li>`);
                        html += '</ul>';
                    }
                    html += '<details style="margin-top: 20px;"><summary style="color: #fff; cursor: pointer;">View Full JSON</summary><pre style="background: #1a1a1a; padding: 15px; border-radius: 8px; overflow-x: auto; margin-top: 10px; color: #999;">' + JSON.stringify(data, null, 2) + '</pre></details>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                loading.style.display = 'none';
                results.style.display = 'block';
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function analyzeAINetwork() {
            const entity = document.getElementById('ai-entity').value;
            const loading = document.getElementById('ai-network-loading');
            const results = document.getElementById('ai-results');
            const resultsContent = document.getElementById('ai-results-content');

            loading.style.display = 'block';
            results.style.display = 'none';

            try {
                let url = '/api/ai/relationship-network?min=5';
                if (entity) url += `&entity=${encodeURIComponent(entity)}`;

                const response = await fetch(url);
                const data = await response.json();

                loading.style.display = 'none';
                results.style.display = 'block';

                let html = '<h2 style="color: #ff9800; margin-bottom: 20px;">Relationship Network Analysis</h2>';

                if (data.error) {
                    html += `<p style="color: #d32f2f;">${data.error}</p>`;
                } else {
                    if (data.executive_summary) {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 15px 0;"><strong style="color: #fff;">Summary:</strong><br><span style="color: #999;">${data.executive_summary}</span></div>`;
                    }
                    if (data.key_players && data.key_players.length) {
                        html += '<h3 style="color: #ff9800; margin-top: 20px;">Key Players in Criminal Network</h3><ul style="color: #999;">';
                        data.key_players.forEach(player => html += `<li style="margin: 8px 0;">${player}</li>`);
                        html += '</ul>';
                    }
                    if (data.suspicious_connections && data.suspicious_connections.length) {
                        html += '<h3 style="color: #d32f2f; margin-top: 20px;">Suspicious Connections</h3><ul style="color: #999;">';
                        data.suspicious_connections.forEach(conn => html += `<li style="margin: 8px 0;">${conn}</li>`);
                        html += '</ul>';
                    }
                    html += '<details style="margin-top: 20px;"><summary style="color: #fff; cursor: pointer;">View Full JSON</summary><pre style="background: #1a1a1a; padding: 15px; border-radius: 8px; overflow-x: auto; margin-top: 10px; color: #999;">' + JSON.stringify(data, null, 2) + '</pre></details>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                loading.style.display = 'none';
                results.style.display = 'block';
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function findAIPatterns() {
            const loading = document.getElementById('ai-patterns-loading');
            const results = document.getElementById('ai-results');
            const resultsContent = document.getElementById('ai-results-content');

            loading.style.display = 'block';
            results.style.display = 'none';

            try {
                const response = await fetch('/api/ai/suspicious-patterns');
                const data = await response.json();

                loading.style.display = 'none';
                results.style.display = 'block';

                let html = '<h2 style="color: #4caf50; margin-bottom: 20px;">Suspicious Patterns Found</h2>';

                if (data.error) {
                    html += `<p style="color: #d32f2f;">${data.error}</p>`;
                } else {
                    html += `<p style="color: #fff;">Total suspicious documents: <strong>${data.total_suspicious || 0}</strong></p>`;

                    if (data.documents && data.documents.length) {
                        html += '<div style="margin-top: 20px;">';
                        data.documents.slice(0, 20).forEach(doc => {
                            html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #ff9800;">
                                <strong style="color: #fff;">Document ${doc.doc_id}: ${doc.filename}</strong><br>
                                <span style="color: #999;">Keywords: ${doc.keywords.join(', ')}</span><br>
                                <span style="color: #666; font-size: 13px;">${doc.excerpt.substring(0, 300)}...</span>
                            </div>`;
                        });
                        html += '</div>';
                    }
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                loading.style.display = 'none';
                results.style.display = 'block';
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        // AI Journalist Assistant Functions
        async function askJournalistQuestion() {
            const query = document.getElementById('journalist-query-input').value.trim();

            if (!query) {
                alert('Please enter a question');
                return;
            }

            const loading = document.getElementById('journalist-loading');
            const results = document.getElementById('journalist-results');

            loading.style.display = 'block';
            results.style.display = 'none';

            try {
                const response = await fetch('/api/ai/journalist-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();

                loading.style.display = 'none';
                results.style.display = 'block';

                let html = `<h3 style="color: #f50057; margin-bottom: 15px;">üìù Query: "${query}"</h3>`;

                if (data.error) {
                    html += `<p style="color: #d32f2f;">Error: ${data.error}</p>`;
                } else {
                    // Main answer
                    html += `<div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #f50057;">`;
                    html += `<h4 style="margin: 0 0 10px 0; color: #333;">Answer</h4>`;
                    html += `<div style="color: #666; white-space: pre-wrap;">${data.answer.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`;
                    html += `</div>`;

                    // Evidence
                    if (data.evidence && data.evidence.length > 0) {
                        html += `<h4 style="color: #333; margin: 25px 0 15px 0;">üìö Evidence (${data.evidence.length} documents)</h4>`;

                        data.evidence.slice(0, 10).forEach((ev, idx) => {
                            html += `<div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #2196f3;">`;
                            html += `<strong style="color: #2196f3;">${idx + 1}. ${ev.document || 'Document ' + (ev.doc_id || '')}</strong>`;

                            if (ev.excerpts && ev.excerpts.length > 0) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-style: italic; color: #555;">`;
                                ev.excerpts.forEach(excerpt => {
                                    html += `<p style="margin: 5px 0;">"${excerpt.substring(0, 300)}${excerpt.length > 300 ? '...' : ''}"</p>`;
                                });
                                html += `</div>`;
                            }

                            if (ev.amounts && ev.amounts.length > 0) {
                                html += `<p style="margin-top: 8px; color: #4caf50;"><strong>Amounts:</strong> ${ev.amounts.slice(0, 5).join(', ')}</p>`;
                            }

                            if (ev.people_involved && ev.people_involved.length > 0) {
                                html += `<p style="margin-top: 8px; color: #ff9800;"><strong>People:</strong> ${ev.people_involved.slice(0, 5).join(', ')}</p>`;
                            }

                            if (ev.dates && ev.dates.length > 0) {
                                html += `<p style="margin-top: 8px; color: #9c27b0;"><strong>Dates:</strong> ${ev.dates.slice(0, 5).join(', ')}</p>`;
                            }

                            if (ev.doc_id) {
                                html += `<p style="margin-top: 8px; font-size: 12px; color: #999;">Document ID: ${ev.doc_id}</p>`;
                            }

                            html += `</div>`;
                        });

                        if (data.evidence.length > 10) {
                            html += `<p style="color: #999; margin-top: 10px;">...and ${data.evidence.length - 10} more documents</p>`;
                        }
                    }

                    // Actionable leads
                    if (data.actionable_leads && data.actionable_leads.length > 0) {
                        html += `<h4 style="color: #333; margin: 25px 0 15px 0;">üéØ Actionable Investigation Leads</h4>`;
                        html += `<ul style="list-style: none; padding: 0;">`;
                        data.actionable_leads.forEach(lead => {
                            html += `<li style="background: #fff3e0; padding: 12px; margin: 8px 0; border-radius: 4px; border-left: 3px solid #ff9800;">
                                <span style="color: #f57c00;">‚ñ∏</span> ${lead}
                            </li>`;
                        });
                        html += `</ul>`;
                    }

                    // Confidence
                    if (data.confidence) {
                        const confidenceColor = data.confidence === 'high' ? '#4caf50' : data.confidence === 'medium' ? '#ff9800' : '#999';
                        html += `<div style="margin-top: 20px; padding: 10px; background: ${confidenceColor}20; border-radius: 4px; text-align: center;">`;
                        html += `<strong style="color: ${confidenceColor};">Confidence: ${data.confidence.toUpperCase()}</strong>`;
                        html += `</div>`;
                    }
                }

                results.innerHTML = html;
            } catch (error) {
                loading.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('journalist-query-input');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        askJournalistQuestion();
                    }
                });
            }
        });

        // Flight Log Functions
        async function loadFlightStats() {
            try {
                console.log('Loading flight stats...');
                const response = await fetch('/api/flights/stats');
                const data = await response.json();

                console.log('Flight stats data:', data);

                document.getElementById('flight-count').textContent = (data.total_flights || 0).toLocaleString();
                document.getElementById('passenger-count').textContent = (data.unique_passengers || 0).toLocaleString();
                document.getElementById('minor-count').textContent = (data.minor_passengers || 0).toLocaleString();
                document.getElementById('route-count').textContent = (data.unique_routes || 0).toLocaleString();

                console.log('Flight stats updated successfully');
            } catch (error) {
                console.error('Error loading flight stats:', error);
                alert('Error loading flight stats: ' + error.message);
            }
        }

        async function loadMinorAlerts() {
            const results = document.getElementById('flight-results');
            const resultsContent = document.getElementById('flight-results-content');

            results.style.display = 'block';

            try {
                const response = await fetch('/api/flights/minor-alerts');
                const data = await response.json();

                let html = '<h2 style="color: #d32f2f; margin-bottom: 20px;">üö® MINOR TRAVEL ALERTS</h2>';
                html += `<p style="color: #fff;">Total alerts: <strong style="color: #d32f2f;">${data.count}</strong></p>`;

                if (data.alerts && data.alerts.length) {
                    html += '<div style="margin-top: 20px;">';
                    data.alerts.forEach(alert => {
                        html += `<div style="background: #ffebee; color: #000; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #d32f2f;">
                            <strong style="color: #d32f2f;">‚ö†Ô∏è MINOR: ${alert.passenger_name}</strong> (Age: ${alert.age || 'Unknown'})<br>
                            <strong>Date:</strong> ${alert.date || 'Unknown'}<br>
                            <strong>Route:</strong> ${alert.origin || '?'} ‚Üí ${alert.destination || '?'}<br>
                            <strong>Adult Passengers:</strong> ${alert.adult_passengers || 'None listed'}
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color: #999;">No minor travel alerts found. Import flight logs to analyze.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function loadPassengerHistory() {
            const passengerName = document.getElementById('flight-passenger-name').value;
            if (!passengerName) {
                alert('Please enter a passenger name');
                return;
            }

            const results = document.getElementById('flight-results');
            const resultsContent = document.getElementById('flight-results-content');

            results.style.display = 'block';

            try {
                const response = await fetch(`/api/flights/passenger/${encodeURIComponent(passengerName)}`);
                const data = await response.json();

                let html = `<h2 style="color: #2196f3; margin-bottom: 20px;">üë§ Flight History: ${data.passenger}</h2>`;

                if (data.flights && data.flights.length) {
                    html += `<p style="color: #fff;">Total flights: <strong>${data.flights.length}</strong></p>`;
                    html += '<div style="margin-top: 20px;">';
                    data.flights.forEach(flight => {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #2196f3;">
                            <strong style="color: #fff;">Date:</strong> ${flight.date || 'Unknown'}<br>
                            <strong style="color: #fff;">Route:</strong> ${flight.origin || '?'} ‚Üí ${flight.destination || '?'}<br>
                            <strong style="color: #fff;">Tail #:</strong> ${flight.tail_number || 'Unknown'}<br>
                            ${flight.age ? `<strong style="color: #ff9800;">Age:</strong> ${flight.age}${flight.is_minor ? ' <span style="color: #d32f2f; font-weight: bold;">(MINOR)</span>' : ''}<br>` : ''}
                            <strong style="color: #fff;">Co-Passengers:</strong> ${flight.co_passengers || 'None listed'}
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color: #999;">No flights found for this passenger.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function loadFrequentFlyers() {
            const results = document.getElementById('flight-results');
            const resultsContent = document.getElementById('flight-results-content');

            results.style.display = 'block';

            try {
                const response = await fetch('/api/flights/frequent-flyers?min=3');
                const data = await response.json();

                let html = '<h2 style="color: #4caf50; margin-bottom: 20px;">üîÅ Frequent Flyers</h2>';

                if (data.flyers && data.flyers.length) {
                    html += '<div style="margin-top: 20px;">';
                    data.flyers.forEach((flyer, i) => {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #4caf50;">
                            <strong style="color: #fff; font-size: 18px;">#${i+1}: ${flyer.passenger_name}</strong><br>
                            <strong style="color: #4caf50;">Flights:</strong> ${flyer.flight_count}<br>
                            ${flyer.age_if_known ? `<strong style="color: #ff9800;">Age:</strong> ${flyer.age_if_known}` : ''}
                            ${flyer.minor_flights > 0 ? `<br><strong style="color: #d32f2f;">‚ö†Ô∏è Flew as minor:</strong> ${flyer.minor_flights} times` : ''}
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color: #999;">No frequent flyers found. Import flight logs to analyze.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function loadCotravelNetwork() {
            const results = document.getElementById('flight-results');
            const resultsContent = document.getElementById('flight-results-content');

            results.style.display = 'block';

            try {
                const response = await fetch('/api/flights/cotravel?min=2');
                const data = await response.json();

                let html = '<h2 style="color: #9c27b0; margin-bottom: 20px;">üï∏Ô∏è Co-Travel Network</h2>';
                html += '<p style="color: #999; margin-bottom: 20px;">Shows who flew together multiple times - critical for understanding relationships</p>';

                if (data.network && data.network.length) {
                    html += '<div style="margin-top: 20px;">';
                    data.network.forEach(pair => {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #9c27b0;">
                            <strong style="color: #fff;">${pair.passenger1}</strong> ‚Üî <strong style="color: #fff;">${pair.passenger2}</strong><br>
                            <strong style="color: #9c27b0;">Flew together:</strong> ${pair.flight_count} times
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color: #999;">No co-travel data found. Import flight logs to analyze.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        // ====================================================================
        // EMAIL INTELLIGENCE FUNCTIONS
        // ====================================================================

        async function loadEmailStats() {
            try {
                const response = await fetch('/api/emails/stats');
                const data = await response.json();

                document.getElementById('email-count').textContent = data.total_emails || 0;
                document.getElementById('suspicious-email-count').textContent = data.suspicious_emails || 0;
                document.getElementById('email-thread-count').textContent = data.total_threads || 0;
                document.getElementById('minor-thread-count').textContent = data.threads_with_minors || 0;
            } catch (error) {
                console.error('Error loading email stats:', error);
            }
        }

        async function loadSuspiciousEmails() {
            const resultsDiv = document.getElementById('email-results');
            const resultsContent = document.getElementById('email-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Loading...</p>';

            try {
                const response = await fetch('/api/emails/suspicious');
                const data = await response.json();

                let html = '<h2 style="color: #d32f2f; margin-bottom: 20px;">üö® Suspicious Emails</h2>';
                html += `<p style="color: #999; margin-bottom: 20px;">Found ${data.count} emails with suspicious keywords and patterns</p>`;

                if (data.emails && data.emails.length) {
                    data.emails.forEach(email => {
                        const keywords = email.suspicious_keywords || {};
                        const keywordText = Object.entries(keywords)
                            .map(([cat, words]) => `${cat}: ${words.join(', ')}`)
                            .join('<br>');

                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #d32f2f;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #fff;">From:</strong> <span style="color: #4fc3f7;">${email.from_name || email.from_address}</span><br>
                                <strong style="color: #fff;">Subject:</strong> ${email.subject || 'No Subject'}<br>
                                <strong style="color: #fff;">Date:</strong> ${email.date_sent || 'Unknown'}
                            </div>
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px;">
                                <strong style="color: #d32f2f;">Suspicious Keywords:</strong><br>
                                <span style="color: #ff9999;">${keywordText}</span>
                            </div>
                            <button onclick="viewDocument(${email.source_doc_id})" style="margin-top: 10px; padding: 8px 15px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                View Full Email
                            </button>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #999;">No suspicious emails found.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function loadHighPriorityThreads() {
            const resultsDiv = document.getElementById('email-results');
            const resultsContent = document.getElementById('email-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Loading...</p>';

            try {
                const response = await fetch('/api/emails/threads?min=2');
                const data = await response.json();

                let html = '<h2 style="color: #ff9800; margin-bottom: 20px;">üßµ High-Priority Email Threads</h2>';
                html += `<p style="color: #999; margin-bottom: 20px;">Found ${data.count} email threads with multiple red flags</p>`;

                if (data.threads && data.threads.length) {
                    data.threads.forEach(thread => {
                        const flags = [];
                        if (thread.has_minors_mentioned) flags.push('‚ö†Ô∏è Minors Mentioned');
                        if (thread.has_travel_mentioned) flags.push('‚úàÔ∏è Travel Mentioned');
                        if (thread.suspicion_score >= 5) flags.push('üö® HIGH SUSPICION');

                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #ff9800;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #fff;">Subject:</strong> ${thread.subject}<br>
                                <strong style="color: #fff;">Messages:</strong> ${thread.message_count}<br>
                                <strong style="color: #fff;">Date Range:</strong> ${thread.start_date} ‚Üí ${thread.end_date}<br>
                                <strong style="color: #fff;">Participants:</strong> <span style="color: #4fc3f7;">${thread.participants}</span>
                            </div>
                            ${flags.length ? `<div style="margin: 10px 0;">${flags.join(' | ')}</div>` : ''}
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px;">
                                <strong style="color: #ff9800;">Suspicion Score:</strong> <span style="font-size: 18px; color: ${thread.suspicion_score >= 5 ? '#f44336' : '#ff9800'};">${thread.suspicion_score}</span>
                            </div>
                            <button onclick="viewThread('${thread.thread_id}')" style="margin-top: 10px; padding: 8px 15px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                View Thread
                            </button>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #999;">No high-priority threads found.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function viewThread(threadId) {
            const resultsDiv = document.getElementById('email-results');
            const resultsContent = document.getElementById('email-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Loading thread...</p>';

            try {
                const response = await fetch(`/api/emails/thread/${threadId}`);
                const data = await response.json();

                let html = '<h2 style="color: #1976d2; margin-bottom: 20px;">üìß Email Thread</h2>';

                if (data.emails && data.emails.length) {
                    data.emails.forEach((email, index) => {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid ${email.is_suspicious ? '#d32f2f' : '#1976d2'};">
                            <div style="color: #999; font-size: 12px; margin-bottom: 10px;">Message ${index + 1} of ${data.emails.length}</div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #fff;">From:</strong> <span style="color: #4fc3f7;">${email.from_name || email.from_address}</span><br>
                                <strong style="color: #fff;">To:</strong> ${email.to_addresses}<br>
                                <strong style="color: #fff;">Date:</strong> ${email.date_sent}<br>
                                <strong style="color: #fff;">Subject:</strong> ${email.subject}
                            </div>
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; white-space: pre-wrap; color: #ccc; max-height: 400px; overflow-y: auto;">
                                ${email.body}
                            </div>
                            ${email.is_suspicious ? '<div style="color: #d32f2f; margin-top: 10px;">üö® FLAGGED AS SUSPICIOUS</div>' : ''}
                        </div>`;
                    });
                    html += '<button onclick="loadHighPriorityThreads()" style="margin-top: 20px; padding: 10px 20px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Back to Threads</button>';
                } else {
                    html += '<p style="color: #999;">No emails found in this thread.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function searchEmails() {
            const query = document.getElementById('email-search-query').value;
            if (!query) {
                alert('Please enter a search term');
                return;
            }

            const resultsDiv = document.getElementById('email-results');
            const resultsContent = document.getElementById('email-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Searching...</p>';

            try {
                const response = await fetch(`/api/emails/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                let html = `<h2 style="color: #1976d2; margin-bottom: 20px;">üîç Search Results for "${query}"</h2>`;
                html += `<p style="color: #999; margin-bottom: 20px;">Found ${data.count} matching emails</p>`;

                if (data.results && data.results.length) {
                    data.results.forEach(email => {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid ${email.is_suspicious ? '#d32f2f' : '#1976d2'};">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #fff;">From:</strong> <span style="color: #4fc3f7;">${email.from_name || email.from_address}</span><br>
                                <strong style="color: #fff;">Subject:</strong> ${email.subject || 'No Subject'}<br>
                                <strong style="color: #fff;">Date:</strong> ${email.date_sent || 'Unknown'}
                            </div>
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; color: #ccc;">
                                ${email.preview}...
                            </div>
                            ${email.is_suspicious ? '<div style="color: #d32f2f; margin-top: 10px;">üö® FLAGGED AS SUSPICIOUS</div>' : ''}
                            <button onclick="viewDocument(${email.source_doc_id})" style="margin-top: 10px; padding: 8px 15px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                View Full Email
                            </button>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #999;">No emails found matching your search.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function reconstructThreads() {
            if (!confirm('This will reconstruct email threads from all imported emails. Continue?')) {
                return;
            }

            const resultsDiv = document.getElementById('email-results');
            const resultsContent = document.getElementById('email-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Reconstructing threads... this may take a moment...</p>';

            try {
                const response = await fetch('/api/emails/reconstruct', { method: 'POST' });
                const data = await response.json();

                let html = '<h2 style="color: #9c27b0; margin-bottom: 20px;">üîÑ Thread Reconstruction Complete</h2>';
                html += `<div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <div style="font-size: 18px; margin-bottom: 10px;">
                        <strong style="color: #fff;">Threads Created:</strong> <span style="color: #9c27b0; font-size: 24px;">${data.threads}</span>
                    </div>
                    <div style="font-size: 18px;">
                        <strong style="color: #fff;">Contact Relationships:</strong> <span style="color: #9c27b0; font-size: 24px;">${data.contacts}</span>
                    </div>
                </div>`;
                html += '<button onclick="loadEmailStats(); loadHighPriorityThreads();" style="margin-top: 20px; padding: 10px 20px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer;">View High-Priority Threads</button>';

                resultsContent.innerHTML = html;
                loadEmailStats();
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        // ====================================================================
        // FINANCIAL TRACKING FUNCTIONS
        // ====================================================================

        async function loadFinancialStats() {
            try {
                const response = await fetch('/api/financial/stats');
                const data = await response.json();

                document.getElementById('transaction-count').textContent = data.total_transactions || 0;
                document.getElementById('suspicious-transaction-count').textContent = data.suspicious_transactions || 0;
                document.getElementById('pattern-count').textContent = data.suspicious_patterns || 0;
                document.getElementById('financial-entity-count').textContent = data.financial_entities || 0;
            } catch (error) {
                console.error('Error loading financial stats:', error);
            }
        }

        async function loadSuspiciousTransactions() {
            const resultsDiv = document.getElementById('financial-results');
            const resultsContent = document.getElementById('financial-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Loading...</p>';

            try {
                const response = await fetch('/api/financial/suspicious');
                const data = await response.json();

                let html = '<h2 style="color: #d32f2f; margin-bottom: 20px;">üö® Suspicious Transactions</h2>';
                html += `<p style="color: #999; margin-bottom: 20px;">Found ${data.count} suspicious transactions</p>`;

                if (data.transactions && data.transactions.length) {
                    data.transactions.forEach(t => {
                        const redFlags = t.red_flags || [];

                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #d32f2f;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4caf50; font-size: 20px;">$${t.amount.toLocaleString()}</strong> <span style="color: #999;">${t.currency}</span><br>
                                ${t.from_entity ? `<strong style="color: #fff;">From:</strong> <span style="color: #4fc3f7;">${t.from_entity}</span><br>` : ''}
                                ${t.to_entity ? `<strong style="color: #fff;">To:</strong> <span style="color: #4fc3f7;">${t.to_entity}</span><br>` : ''}
                                ${t.transaction_date ? `<strong style="color: #fff;">Date:</strong> ${t.transaction_date}<br>` : ''}
                                ${t.payment_method ? `<strong style="color: #fff;">Method:</strong> ${t.payment_method}<br>` : ''}
                                ${t.purpose ? `<strong style="color: #fff;">Purpose:</strong> ${t.purpose}` : ''}
                            </div>
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px;">
                                <strong style="color: #d32f2f;">üö® Red Flags:</strong><br>
                                ${redFlags.map(flag => `<span style="color: #ff9999;">‚Ä¢ ${flag}</span>`).join('<br>')}
                            </div>
                            <button onclick="viewDocument(${t.source_doc_id})" style="margin-top: 10px; padding: 8px 15px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                View Source Document
                            </button>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #999;">No suspicious transactions found.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function loadFinancialPatterns() {
            const resultsDiv = document.getElementById('financial-results');
            const resultsContent = document.getElementById('financial-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Loading...</p>';

            try {
                const response = await fetch('/api/financial/patterns');
                const data = await response.json();

                let html = '<h2 style="color: #ff9800; margin-bottom: 20px;">üìä Detected Suspicious Patterns</h2>';
                html += `<p style="color: #999; margin-bottom: 20px;">Found ${data.count} suspicious patterns</p>`;

                if (data.patterns && data.patterns.length) {
                    const severityColors = { 'HIGH': '#d32f2f', 'MEDIUM': '#ff9800', 'LOW': '#ffc107' };

                    data.patterns.forEach(p => {
                        const color = severityColors[p.severity] || '#ff9800';

                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid ${color};">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #fff; font-size: 16px;">${p.pattern_type.toUpperCase()}</strong>
                                <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">${p.severity}</span>
                            </div>
                            <p style="color: #ccc; margin: 10px 0;">${p.description}</p>
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin-top: 10px;">
                                <strong style="color: #4caf50;">Total Amount:</strong> <span style="font-size: 18px;">$${p.amount_involved ? p.amount_involved.toLocaleString() : '0'}</span><br>
                                <strong style="color: #fff;">Entities Involved:</strong> <span style="color: #4fc3f7;">${p.entities_involved}</span>
                            </div>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #999;">No suspicious patterns found. Click "Detect New Patterns" to analyze transactions.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function loadMoneyFlows() {
            const entity = document.getElementById('financial-entity-name').value;
            const resultsDiv = document.getElementById('financial-results');
            const resultsContent = document.getElementById('financial-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Loading...</p>';

            try {
                const url = entity
                    ? `/api/financial/money-flows?entity=${encodeURIComponent(entity)}&min=1000`
                    : '/api/financial/money-flows?min=1000';

                const response = await fetch(url);
                const data = await response.json();

                let html = '<h2 style="color: #9c27b0; margin-bottom: 20px;">üí∏ Money Flow Network</h2>';
                html += `<p style="color: #999; margin-bottom: 20px;">Found ${data.count} money flows</p>`;

                if (data.flows && data.flows.length) {
                    data.flows.forEach(flow => {
                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #9c27b0;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4fc3f7;">${flow.from_entity}</strong>
                                <span style="color: #9c27b0; font-size: 20px;"> ‚Üí </span>
                                <strong style="color: #4fc3f7;">${flow.to_entity}</strong>
                            </div>
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px;">
                                <strong style="color: #4caf50;">Total Amount:</strong> <span style="font-size: 18px;">$${flow.total_amount.toLocaleString()}</span><br>
                                <strong style="color: #fff;">Transactions:</strong> ${flow.transaction_count}<br>
                                <strong style="color: #fff;">Average:</strong> $${flow.average_amount ? flow.average_amount.toLocaleString() : '0'}<br>
                                ${flow.suspicious_count > 0 ? `<strong style="color: #d32f2f;">Suspicious Transactions:</strong> ${flow.suspicious_count}<br>` : ''}
                                <strong style="color: #fff;">Period:</strong> ${flow.first_transaction} ‚Üí ${flow.last_transaction}
                            </div>
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #999;">No money flows found. Import financial documents to analyze.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function detectPatterns() {
            if (!confirm('This will analyze all transactions for suspicious patterns. Continue?')) {
                return;
            }

            const resultsDiv = document.getElementById('financial-results');
            const resultsContent = document.getElementById('financial-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Analyzing transactions... this may take a moment...</p>';

            try {
                const response = await fetch('/api/financial/detect-patterns', { method: 'POST' });
                const data = await response.json();

                let html = '<h2 style="color: #4caf50; margin-bottom: 20px;">üîç Pattern Detection Complete</h2>';
                html += `<div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <div style="font-size: 18px;">
                        <strong style="color: #fff;">Patterns Detected:</strong>
                        <span style="color: #4caf50; font-size: 24px;">${data.patterns_detected}</span>
                    </div>
                </div>`;
                html += '<button onclick="loadFinancialPatterns()" style="margin-top: 20px; padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">View Detected Patterns</button>';

                resultsContent.innerHTML = html;
                loadFinancialStats();
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        // ====================================================================
        // TIMELINE FUNCTIONS
        // ====================================================================

        async function loadTimelineStats() {
            try {
                const response = await fetch('/api/timeline/stats');
                const data = await response.json();

                document.getElementById('timeline-event-count').textContent = data.total_events || 0;
                document.getElementById('timeline-suspicious-count').textContent = data.suspicious_events || 0;
                document.getElementById('timeline-cluster-count').textContent = data.total_clusters || 0;

                if (data.date_range && data.date_range.start && data.date_range.end) {
                    document.getElementById('timeline-date-range').textContent =
                        `${data.date_range.start} to ${data.date_range.end}`;
                }
            } catch (error) {
                console.error('Error loading timeline stats:', error);
            }
        }

        async function rebuildTimeline() {
            if (!confirm('This will rebuild the timeline from all sources (flights, emails, transactions). Continue?')) {
                return;
            }

            const resultsDiv = document.getElementById('timeline-results');
            const resultsContent = document.getElementById('timeline-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Rebuilding timeline... this may take a moment...</p>';

            try {
                const response = await fetch('/api/timeline/rebuild', { method: 'POST' });
                const data = await response.json();

                let html = '<h2 style="color: #9c27b0; margin-bottom: 20px;">üîÑ Timeline Rebuilt</h2>';
                html += `<div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <div style="margin-bottom: 10px;"><strong style="color: #fff;">Flight Events:</strong> <span style="color: #ff6f00;">${data.flights}</span></div>
                    <div style="margin-bottom: 10px;"><strong style="color: #fff;">Email Events:</strong> <span style="color: #1976d2;">${data.emails}</span></div>
                    <div style="margin-bottom: 10px;"><strong style="color: #fff;">Transaction Events:</strong> <span style="color: #4caf50;">${data.transactions}</span></div>
                    <div style="font-size: 18px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                        <strong style="color: #fff;">Total Events:</strong> <span style="color: #9c27b0; font-size: 24px;">${data.total}</span>
                    </div>
                </div>`;
                html += '<button onclick="loadAllTimelineEvents()" style="margin-top: 20px; padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">View Timeline</button>';

                resultsContent.innerHTML = html;
                loadTimelineStats();
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function loadAllTimelineEvents() {
            const resultsDiv = document.getElementById('timeline-results');
            const resultsContent = document.getElementById('timeline-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Loading timeline...</p>';

            try {
                const response = await fetch('/api/timeline/events');
                const data = await response.json();

                let html = '<h2 style="color: #9c27b0; margin-bottom: 20px;">üìÖ Complete Timeline</h2>';
                html += `<p style="color: #999; margin-bottom: 20px;">Showing ${data.count} events in chronological order</p>`;

                if (data.events && data.events.length) {
                    data.events.forEach(event => {
                        const typeColors = {
                            'travel': '#ff6f00',
                            'communication': '#1976d2',
                            'financial': '#4caf50'
                        };
                        const color = typeColors[event.event_type] || '#9c27b0';

                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid ${color};">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4fc3f7;">${event.event_date}</strong>
                                <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">${event.event_type}</span>
                                ${event.is_suspicious ? '<span style="background: #d32f2f; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px;">üö® SUSPICIOUS</span>' : ''}
                            </div>
                            <h4 style="color: #fff; margin: 10px 0;">${event.title}</h4>
                            <p style="color: #ccc; margin: 10px 0;">${event.description || ''}</p>
                            ${event.entities_involved ? `<div style="color: #999; margin-top: 10px;"><strong>Entities:</strong> ${event.entities_involved}</div>` : ''}
                            ${event.location ? `<div style="color: #999;"><strong>Location:</strong> ${event.location}</div>` : ''}
                            ${event.amount ? `<div style="color: #4caf50; font-weight: bold;">$${event.amount.toLocaleString()}</div>` : ''}
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #999;">No timeline events found. Click "Rebuild Timeline" to generate from your data.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function loadSuspiciousTimelineEvents() {
            const resultsDiv = document.getElementById('timeline-results');
            const resultsContent = document.getElementById('timeline-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Loading suspicious events...</p>';

            try {
                const response = await fetch('/api/timeline/events?suspicion=3');
                const data = await response.json();

                let html = '<h2 style="color: #d32f2f; margin-bottom: 20px;">üö® Suspicious Timeline Events</h2>';
                html += `<p style="color: #999; margin-bottom: 20px;">Found ${data.count} suspicious events</p>`;

                if (data.events && data.events.length) {
                    data.events.forEach(event => {
                        const typeColors = {
                            'travel': '#ff6f00',
                            'communication': '#1976d2',
                            'financial': '#4caf50'
                        };
                        const color = typeColors[event.event_type] || '#9c27b0';

                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #d32f2f;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #4fc3f7;">${event.event_date}</strong>
                                <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">${event.event_type}</span>
                                <span style="background: #d32f2f; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px;">SUSPICION: ${event.suspicion_level}/5</span>
                            </div>
                            <h4 style="color: #fff; margin: 10px 0;">${event.title}</h4>
                            <p style="color: #ccc; margin: 10px 0;">${event.description || ''}</p>
                            ${event.entities_involved ? `<div style="color: #999; margin-top: 10px;"><strong>Entities:</strong> ${event.entities_involved}</div>` : ''}
                            ${event.location ? `<div style="color: #999;"><strong>Location:</strong> ${event.location}</div>` : ''}
                            ${event.amount ? `<div style="color: #4caf50; font-weight: bold;">$${event.amount.toLocaleString()}</div>` : ''}
                        </div>`;
                    });
                } else {
                    html += '<p style="color: #999;">No suspicious events found.</p>';
                }

                resultsContent.innerHTML = html;
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        async function detectClusters() {
            if (!confirm('This will detect clusters of related events within 7 days. Continue?')) {
                return;
            }

            const resultsDiv = document.getElementById('timeline-results');
            const resultsContent = document.getElementById('timeline-results-content');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #999;">Detecting event clusters...</p>';

            try {
                const response = await fetch('/api/timeline/detect-clusters', { method: 'POST' });
                const data = await response.json();

                let html = '<h2 style="color: #4caf50; margin-bottom: 20px;">üîç Cluster Detection Complete</h2>';
                html += `<div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <div style="font-size: 18px;">
                        <strong style="color: #fff;">Clusters Detected:</strong>
                        <span style="color: #4caf50; font-size: 24px;">${data.clusters_detected}</span>
                    </div>
                </div>`;

                // Load clusters
                const clustersResponse = await fetch('/api/timeline/clusters');
                const clustersData = await clustersResponse.json();

                if (clustersData.clusters && clustersData.clusters.length) {
                    html += '<h3 style="color: #fff; margin: 30px 0 20px 0;">Detected Clusters:</h3>';

                    const significanceColors = { 'HIGH': '#d32f2f', 'MEDIUM': '#ff9800', 'LOW': '#ffc107' };

                    clustersData.clusters.forEach(cluster => {
                        const color = significanceColors[cluster.significance] || '#ff9800';

                        html += `<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid ${color};">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #fff; font-size: 16px;">${cluster.cluster_name}</strong>
                                <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">${cluster.significance}</span>
                            </div>
                            <p style="color: #ccc; margin: 10px 0;">${cluster.description}</p>
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin-top: 10px;">
                                <div><strong style="color: #fff;">Events:</strong> ${cluster.event_count}</div>
                                <div><strong style="color: #fff;">Date Range:</strong> ${cluster.start_date} to ${cluster.end_date}</div>
                            </div>
                        </div>`;
                    });
                }

                resultsContent.innerHTML = html;
                loadTimelineStats();
            } catch (error) {
                resultsContent.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        // Load stats when tab is switched
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'flight-logs') {
                loadFlightStats();
            }
            if (tabName === 'email-intelligence') {
                loadEmailStats();
            }
            if (tabName === 'financial-tracker') {
                loadFinancialStats();
            }
            if (tabName === 'timeline') {
                loadTimelineStats();
            }
            if (tabName === 'leads') {
                loadLeadStats();
            }
        };

        // ================================================================
        // LEADS FUNCTIONALITY
        // ================================================================

        async function initializeLeads() {
            try {
                const response = await fetch('/api/leads/init', { method: 'POST' });
                const data = await response.json();
                alert(data.message || 'Leads system initialized');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function generateLeads() {
            const resultsDiv = document.getElementById('leads-results');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="border: 3px solid #333; border-top: 3px solid #e91e63; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div><div style="color: #999;">Analyzing all evidence and generating leads...</div></div>';

            try {
                const response = await fetch('/api/leads/generate', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert(`Generated ${data.leads_created} leads!\n\n` +
                          `Contradictions: ${data.by_type.contradictions}\n` +
                          `Emails: ${data.by_type.emails}\n` +
                          `Flights: ${data.by_type.flights}\n` +
                          `Financial: ${data.by_type.financial}\n` +
                          `Networks: ${data.by_type.networks}`);
                    loadLeads();
                    loadLeadStats();
                } else {
                    alert('Error generating leads');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: #d32f2f; padding: 20px;">Error: ${error.message}</div>`;
            }
        }

        async function loadLeads() {
            const resultsDiv = document.getElementById('leads-results');
            const status = document.getElementById('lead-status-filter').value;
            const type = document.getElementById('lead-type-filter').value;

            resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Loading leads...</div>';

            try {
                let url = '/api/leads?limit=50';
                if (status) url += `&status=${status}`;
                if (type) url += `&type=${type}`;

                const response = await fetch(url);
                const data = await response.json();

                if (!data.leads || data.leads.length === 0) {
                    resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No leads found. Click "Generate Leads" to analyze evidence.</div>';
                    return;
                }

                let html = '';
                data.leads.forEach(lead => {
                    const priorityPercent = Math.round(lead.priority_score * 100);
                    const priorityColor = priorityPercent >= 70 ? '#d32f2f' : priorityPercent >= 50 ? '#ff9800' : '#4caf50';
                    const statusColor = lead.status === 'resolved' ? '#4caf50' : lead.status === 'investigating' ? '#ff9800' : '#2196f3';

                    html += `
                        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${priorityColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <h3 style="color: #fff; margin-bottom: 8px;">${lead.lead_title}</h3>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: ${priorityColor}; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                                            ${priorityPercent}% Priority
                                        </span>
                                        <span style="background: ${statusColor}; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px;">
                                            ${lead.status.toUpperCase()}
                                        </span>
                                        <span style="background: #666; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px;">
                                            ${lead.lead_type.replace('_', ' ').toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${lead.status !== 'investigating' ? `
                                        <button onclick="updateLeadStatus(${lead.id}, 'investigating')" style="padding: 8px 15px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            Start Investigating
                                        </button>
                                    ` : ''}
                                    ${lead.status !== 'resolved' ? `
                                        <button onclick="updateLeadStatus(${lead.id}, 'resolved')" style="padding: 8px 15px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                            Mark Resolved
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="color: #ccc; line-height: 1.6; white-space: pre-wrap;">${lead.lead_description}</div>
                            ${lead.investigation_notes ? `
                                <div style="margin-top: 15px; padding: 12px; background: #2d2d2d; border-radius: 4px;">
                                    <strong style="color: #4caf50;">Notes:</strong> ${lead.investigation_notes}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: #d32f2f; padding: 20px;">Error: ${error.message}</div>`;
            }
        }

        async function updateLeadStatus(leadId, newStatus) {
            const notes = prompt(`Update status to "${newStatus}". Add notes (optional):`);

            try {
                const response = await fetch(`/api/leads/${leadId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, notes })
                });

                const data = await response.json();
                if (data.success) {
                    loadLeads();
                    loadLeadStats();
                } else {
                    alert('Error updating lead');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadLeadStats() {
            try {
                const response = await fetch('/api/leads/stats');
                const stats = await response.json();

                document.getElementById('leads-total').textContent = stats.total_leads || 0;
                document.getElementById('leads-high-priority').textContent = stats.high_priority || 0;
                document.getElementById('leads-investigating').textContent = stats.by_status?.investigating || 0;
                document.getElementById('leads-resolved').textContent = stats.by_status?.resolved || 0;
            } catch (error) {
                console.error('Error loading lead stats:', error);
            }
        }

        // =============================================================================
        // VISUAL INTELLIGENCE - AI-POWERED IMAGE ANALYSIS
        // =============================================================================

        async function initializeVisualIntelligence() {
            if (!confirm('Initialize Visual Intelligence system?\n\nThis will create database tables for image analysis.')) return;

            const button = event.target;
            button.disabled = true;
            button.textContent = 'Initializing...';

            try {
                const response = await fetch('/api/visual-intelligence/init', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('‚úì Visual Intelligence initialized!\n\nNow click "Analyze All Images" to process photos.');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = '1. Initialize System';
            }
        }

        async function analyzeAllImages() {
            if (!confirm('Analyze all images with AI?\n\nThis will:\n‚Ä¢ Detect faces using OpenCV\n‚Ä¢ Extract EXIF metadata\n‚Ä¢ Detect GPS locations\n‚Ä¢ Classify scenes\n‚Ä¢ Flag suspicious images\n\nThis may take several minutes for large image collections.')) return;

            const button = event.target;
            button.disabled = true;
            button.textContent = 'Analyzing...';

            const resultsDiv = document.getElementById('images-results');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üîç</div>
                    <div style="color: #9c27b0; font-size: 18px; margin-bottom: 10px;">Analyzing images with AI...</div>
                    <div style="color: #999;">Please wait. This may take a few minutes.</div>
                </div>
            `;

            try {
                const response = await fetch('/api/visual-intelligence/analyze-all', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úì Analysis Complete!\n\n` +
                          `Processed: ${data.processed} images\n` +
                          `Failed: ${data.failed}\n` +
                          `Total Faces: ${data.total_faces}\n` +
                          `Suspicious: ${data.suspicious_images}`);
                    loadVisualIntelligenceStats();
                    loadAnalyzedImages();
                } else {
                    alert('Error: ' + (data.error || data.message));
                }
            } catch (error) {
                alert('Error: ' + error.message);
                resultsDiv.innerHTML = `<div style="color: #d32f2f; padding: 20px;">Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = '2. Analyze All Images';
            }
        }

        async function findSimilarImages() {
            if (!confirm('Find similar or duplicate images?\n\nThis uses perceptual hashing to identify visually similar images.')) return;

            const button = event.target;
            button.disabled = true;
            button.textContent = 'Searching...';

            try {
                const response = await fetch('/api/visual-intelligence/find-similar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ min_similarity: 0.9 })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úì Similar Image Search Complete!\n\n` +
                          `Found ${data.pairs_found} similar/duplicate pairs\n` +
                          `Images compared: ${data.images_compared}`);
                    loadAnalyzedImages();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Find Similar/Duplicates';
            }
        }

        async function loadAnalyzedImages() {
            const resultsDiv = document.getElementById('images-results');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Loading analyzed images...</div>';

            try {
                // Build query params from filters
                const params = new URLSearchParams();

                if (document.getElementById('filter-has-faces').checked) {
                    params.append('has_faces', 'true');
                }
                if (document.getElementById('filter-has-location').checked) {
                    params.append('has_location', 'true');
                }
                if (document.getElementById('filter-suspicious').checked) {
                    params.append('min_suspicious_score', '0.5');
                }
                const sceneType = document.getElementById('scene-type-filter').value;
                if (sceneType) {
                    params.append('scene_type', sceneType);
                }
                params.append('limit', '100');

                const response = await fetch(`/api/visual-intelligence/analyzed-images?${params}`);
                const data = await response.json();

                if (!data.images || data.images.length === 0) {
                    resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No analyzed images found. Click "Analyze All Images" to start.</div>';
                    return;
                }

                let html = `<div style="color: #999; margin-bottom: 20px;">Found ${data.count} analyzed images</div>`;

                data.images.forEach(img => {
                    const suspiciousColor = img.suspicious_score >= 0.7 ? '#d32f2f' : img.suspicious_score >= 0.5 ? '#ff9800' : '#4caf50';
                    const suspiciousLabel = img.suspicious_score >= 0.7 ? 'HIGH' : img.suspicious_score >= 0.5 ? 'MEDIUM' : 'LOW';

                    html += `
                        <div style="background: #1a1a1a; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid ${suspiciousColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #9c27b0; font-size: 16px;">${img.filename}</strong>
                                    <div style="margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap;">
                                        <span style="background: ${suspiciousColor}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                            SUSPICION: ${suspiciousLabel} (${Math.round(img.suspicious_score * 100)}%)
                                        </span>
                                        ${img.faces_detected > 0 ? `
                                            <span style="background: #2196f3; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px;">
                                                üë§ ${img.faces_detected} Face${img.faces_detected > 1 ? 's' : ''}
                                            </span>
                                        ` : ''}
                                        ${img.location_lat ? `
                                            <span style="background: #4caf50; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px;">
                                                üìç GPS: ${img.location_lat.toFixed(4)}, ${img.location_lon.toFixed(4)}
                                            </span>
                                        ` : ''}
                                        <span style="background: #666; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px;">
                                            ${img.scene_type}
                                        </span>
                                    </div>
                                </div>
                                <div style="text-align: right; color: #999; font-size: 14px;">
                                    ${img.width}√ó${img.height}
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                                <div>
                                    <img src="/api/documents/${img.doc_id}"
                                         style="width: 100%; max-height: 300px; object-fit: contain; background: #000; border-radius: 4px; cursor: pointer;"
                                         onclick="viewDocument(${img.doc_id})"
                                         onerror="this.style.display='none'">
                                </div>
                                <div style="color: #ccc; font-size: 14px; line-height: 1.8;">
                                    ${img.camera_make ? `<div><strong>Camera:</strong> ${img.camera_make} ${img.camera_model || ''}</div>` : ''}
                                    ${img.date_taken ? `<div><strong>Date Taken:</strong> ${img.date_taken}</div>` : ''}
                                    ${img.file_size ? `<div><strong>Size:</strong> ${(img.file_size / 1024 / 1024).toFixed(2)} MB</div>` : ''}
                                    ${img.image_hash ? `<div><strong>Hash:</strong> ${img.image_hash.substring(0, 16)}...</div>` : ''}
                                </div>
                            </div>

                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #3d3d3d;">
                                <button onclick="viewImageAnalysis(${img.doc_id})" style="padding: 8px 16px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                    üìä Full Analysis
                                </button>
                                <button onclick="viewDocument(${img.doc_id})" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    üëÅÔ∏è View Image
                                </button>
                            </div>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: #d32f2f; padding: 20px;">Error: ${error.message}</div>`;
            }
        }

        async function viewImageAnalysis(docId) {
            try {
                const response = await fetch(`/api/visual-intelligence/analysis/${docId}`);
                const analysis = await response.json();

                if (analysis.error) {
                    alert('No analysis found for this image');
                    return;
                }

                let html = `
                    <h2 style="color: #9c27b0; margin-bottom: 20px;">üì∏ Image Analysis Report</h2>

                    <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #fff; margin-bottom: 15px;">Basic Information</h3>
                        <div style="color: #ccc; line-height: 2;">
                            <div><strong>Image ID:</strong> ${analysis.doc_id}</div>
                            <div><strong>Dimensions:</strong> ${analysis.width}√ó${analysis.height}</div>
                            <div><strong>File Size:</strong> ${(analysis.file_size / 1024 / 1024).toFixed(2)} MB</div>
                            <div><strong>Scene Type:</strong> ${analysis.scene_type}</div>
                            <div><strong>Suspicion Score:</strong> ${Math.round(analysis.suspicious_score * 100)}%</div>
                        </div>
                    </div>

                    ${analysis.faces_detected > 0 ? `
                        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #2196f3; margin-bottom: 15px;">üë§ Face Detection (${analysis.faces_detected} detected)</h3>
                            ${analysis.faces.map((face, i) => `
                                <div style="background: #2d2d2d; padding: 12px; border-radius: 4px; margin-bottom: 10px;">
                                    <div style="color: #fff;"><strong>Face #${face.face_number}</strong></div>
                                    <div style="color: #ccc; font-size: 14px;">
                                        Position: (${face.x}, ${face.y}), Size: ${face.width}√ó${face.height}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${analysis.location_lat ? `
                        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #4caf50; margin-bottom: 15px;">üìç GPS Location</h3>
                            <div style="color: #ccc; line-height: 2;">
                                <div><strong>Latitude:</strong> ${analysis.location_lat}</div>
                                <div><strong>Longitude:</strong> ${analysis.location_lon}</div>
                                <div><a href="https://www.google.com/maps?q=${analysis.location_lat},${analysis.location_lon}" target="_blank" style="color: #4caf50;">View on Google Maps</a></div>
                            </div>
                        </div>
                    ` : ''}

                    ${analysis.camera_make ? `
                        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #ff9800; margin-bottom: 15px;">üì∑ EXIF Metadata</h3>
                            <div style="color: #ccc; line-height: 2;">
                                <div><strong>Camera:</strong> ${analysis.camera_make} ${analysis.camera_model || ''}</div>
                                ${analysis.date_taken ? `<div><strong>Date Taken:</strong> ${analysis.date_taken}</div>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${analysis.similar_images && analysis.similar_images.length > 0 ? `
                        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #e91e63; margin-bottom: 15px;">üîç Similar Images (${analysis.similar_images.length})</h3>
                            ${analysis.similar_images.map(sim => `
                                <div style="background: #2d2d2d; padding: 12px; border-radius: 4px; margin-bottom: 10px;">
                                    <div style="color: #fff;">Document #${sim.similar_doc_id}</div>
                                    <div style="color: #ccc; font-size: 14px;">
                                        Similarity: ${Math.round(sim.similarity_score * 100)}% (${sim.match_type})
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;

                document.getElementById('modal-body').innerHTML = html;
                document.getElementById('modal').style.display = 'block';
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadVisualIntelligenceStats() {
            try {
                const response = await fetch('/api/visual-intelligence/stats');
                const stats = await response.json();

                document.getElementById('images-analyzed').textContent = stats.total_analyzed || 0;
                document.getElementById('images-with-faces').textContent = stats.images_with_faces || 0;
                document.getElementById('images-suspicious').textContent = stats.suspicious_images || 0;
                document.getElementById('images-with-location').textContent = stats.images_with_location || 0;
                document.getElementById('total-faces-detected').textContent = stats.total_faces || 0;
            } catch (error) {
                console.error('Error loading visual intelligence stats:', error);
            }
        }
    </script>
</body>
</html>
